{"ast":null,"code":"/**\r\n * DevExtreme (ui/grid_core/ui.grid_core.data_source_adapter.js)\r\n * Version: 19.2.2\r\n * Build date: Tue Oct 01 2019\r\n *\r\n * Copyright (c) 2012 - 2019 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\n\"use strict\";\n\nvar _callbacks = require(\"../../core/utils/callbacks\");\nvar _callbacks2 = _interopRequireDefault(_callbacks);\nvar _uiData_grid = require(\"../data_grid/ui.data_grid.core\");\nvar _uiData_grid2 = _interopRequireDefault(_uiData_grid);\nvar _common = require(\"../../core/utils/common\");\nvar _type = require(\"../../core/utils/type\");\nvar _type2 = _interopRequireDefault(_type);\nvar _iterator = require(\"../../core/utils/iterator\");\nvar _extend = require(\"../../core/utils/extend\");\nvar _array_store = require(\"../../data/array_store\");\nvar _array_store2 = _interopRequireDefault(_array_store);\nvar _array_utils = require(\"../../data/array_utils\");\nvar _array_utils2 = _interopRequireDefault(_array_utils);\nvar _deferred = require(\"../../core/utils/deferred\");\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    \"default\": obj\n  };\n}\nmodule.exports = _uiData_grid2.default.Controller.inherit(function () {\n  function cloneItems(items, groupCount) {\n    if (items) {\n      items = items.slice(0);\n      if (groupCount) {\n        for (var i = 0; i < items.length; i++) {\n          items[i] = (0, _extend.extend)({\n            key: items[i].key\n          }, items[i]);\n          items[i].items = cloneItems(items[i].items, groupCount - 1);\n        }\n      }\n    }\n    return items;\n  }\n  function calculateOperationTypes(loadOptions, lastLoadOptions) {\n    var operationTypes = {};\n    if (lastLoadOptions) {\n      operationTypes = {\n        sorting: !_uiData_grid2.default.equalSortParameters(loadOptions.sort, lastLoadOptions.sort),\n        grouping: !_uiData_grid2.default.equalSortParameters(loadOptions.group, lastLoadOptions.group, true),\n        groupExpanding: !_uiData_grid2.default.equalSortParameters(loadOptions.group, lastLoadOptions.group) || lastLoadOptions.groupExpand,\n        filtering: !_uiData_grid2.default.equalFilterParameters(loadOptions.filter, lastLoadOptions.filter),\n        pageIndex: loadOptions.pageIndex !== lastLoadOptions.pageIndex,\n        skip: loadOptions.skip !== lastLoadOptions.skip,\n        take: loadOptions.take !== lastLoadOptions.take\n      };\n      operationTypes.reload = operationTypes.sorting || operationTypes.grouping || operationTypes.filtering;\n      operationTypes.paging = operationTypes.pageIndex || operationTypes.take;\n    }\n    return operationTypes;\n  }\n  function executeTask(action, timeout) {\n    if (_type2.default.isDefined(timeout)) {\n      (0, _common.executeAsync)(action, timeout);\n    } else {\n      action();\n    }\n  }\n  function createEmptyPagesData() {\n    return {\n      pages: {}\n    };\n  }\n  function getPageDataFromCache(options) {\n    return options.cachedPagesData.pages[options.pageIndex];\n  }\n  function setPageDataToCache(options, data) {\n    var pageIndex = options.pageIndex;\n    if (void 0 !== pageIndex) {\n      options.cachedPagesData.pages[pageIndex] = data;\n    }\n  }\n  return {\n    init: function init(dataSource, remoteOperations) {\n      var that = this;\n      that._dataSource = dataSource;\n      that._remoteOperations = remoteOperations || {};\n      that._isLastPage = !dataSource.isLastPage();\n      that._hasLastPage = false;\n      that._currentTotalCount = 0;\n      that._cachedPagesData = createEmptyPagesData();\n      that._lastOperationTypes = {};\n      that.changed = (0, _callbacks2.default)();\n      that.loadingChanged = (0, _callbacks2.default)();\n      that.loadError = (0, _callbacks2.default)();\n      that.customizeStoreLoadOptions = (0, _callbacks2.default)();\n      that.changing = (0, _callbacks2.default)();\n      that._dataChangedHandler = that._handleDataChanged.bind(that);\n      that._dataLoadingHandler = that._handleDataLoading.bind(that);\n      that._dataLoadedHandler = that._handleDataLoaded.bind(that);\n      that._loadingChangedHandler = that._handleLoadingChanged.bind(that);\n      that._loadErrorHandler = that._handleLoadError.bind(that);\n      that._pushHandler = that._handlePush.bind(that);\n      that._changingHandler = that._handleChanging.bind(that);\n      dataSource.on(\"changed\", that._dataChangedHandler);\n      dataSource.on(\"customizeStoreLoadOptions\", that._dataLoadingHandler);\n      dataSource.on(\"customizeLoadResult\", that._dataLoadedHandler);\n      dataSource.on(\"loadingChanged\", that._loadingChangedHandler);\n      dataSource.on(\"loadError\", that._loadErrorHandler);\n      dataSource.on(\"changing\", that._changingHandler);\n      dataSource.store().on(\"push\", that._pushHandler);\n      (0, _iterator.each)(dataSource, function (memberName, member) {\n        if (!that[memberName] && _type2.default.isFunction(member)) {\n          that[memberName] = function () {\n            return this._dataSource[memberName].apply(this._dataSource, arguments);\n          };\n        }\n      });\n    },\n    remoteOperations: function remoteOperations() {\n      return this._remoteOperations;\n    },\n    dispose: function dispose(isSharedDataSource) {\n      var that = this,\n        dataSource = that._dataSource,\n        store = dataSource.store();\n      dataSource.off(\"changed\", that._dataChangedHandler);\n      dataSource.off(\"customizeStoreLoadOptions\", that._dataLoadingHandler);\n      dataSource.off(\"customizeLoadResult\", that._dataLoadedHandler);\n      dataSource.off(\"loadingChanged\", that._loadingChangedHandler);\n      dataSource.off(\"loadError\", that._loadErrorHandler);\n      dataSource.off(\"changing\", that._changingHandler);\n      store && store.off(\"push\", that._pushHandler);\n      if (!isSharedDataSource) {\n        dataSource.dispose();\n      }\n    },\n    refresh: function refresh(options, isReload, operationTypes) {\n      var that = this,\n        dataSource = that._dataSource;\n      if (isReload || operationTypes.reload) {\n        that._currentTotalCount = 0;\n        that._isLastPage = !dataSource.paginate();\n        that._hasLastPage = that._isLastPage;\n      }\n    },\n    resetCache: function resetCache() {\n      this._cachedStoreData = void 0;\n      this._cachedPagingData = void 0;\n    },\n    resetPagesCache: function resetPagesCache() {\n      this._cachedPagesData = createEmptyPagesData();\n    },\n    _needClearStoreDataCache: function _needClearStoreDataCache() {\n      var remoteOperations = this.remoteOperations(),\n        operationTypes = calculateOperationTypes(this._lastLoadOptions || {}, {}),\n        isLocalOperations = Object.keys(remoteOperations).every(function (operationName) {\n          return !operationTypes[operationName] || !remoteOperations[operationName];\n        });\n      return !isLocalOperations;\n    },\n    push: function push(changes, fromStore) {\n      var store = this.store();\n      if (this._needClearStoreDataCache()) {\n        this._cachedStoreData = void 0;\n      }\n      this._cachedPagingData = void 0;\n      this.resetPagesCache(true);\n      if (this._cachedStoreData) {\n        _array_utils2.default.applyBatch(store, this._cachedStoreData, changes);\n      }\n      if (!fromStore) {\n        this._applyBatch(changes);\n      }\n    },\n    getDataIndexGetter: function getDataIndexGetter() {\n      var _this = this;\n      if (!this._dataIndexGetter) {\n        var indexByKey;\n        var store = this.store();\n        this._dataIndexGetter = function (data) {\n          var storeData = _this._cachedStoreData || [];\n          if (!indexByKey) {\n            indexByKey = {};\n            for (var i = 0; i < storeData.length; i++) {\n              indexByKey[(0, _common.getKeyHash)(store.keyOf(storeData[i]))] = i;\n            }\n          }\n          return indexByKey[(0, _common.getKeyHash)(store.keyOf(data))];\n        };\n      }\n      return this._dataIndexGetter;\n    },\n    _getKeyInfo: function _getKeyInfo() {\n      return this.store();\n    },\n    _applyBatch: function _applyBatch(changes) {\n      var keyInfo = this._getKeyInfo(),\n        dataSource = this._dataSource,\n        groupCount = _uiData_grid2.default.normalizeSortingInfo(this.group()).length;\n      changes = changes.filter(function (change) {\n        return !dataSource.paginate() || \"insert\" !== change.type || void 0 !== change.index;\n      });\n      _array_utils2.default.applyBatch(keyInfo, this._items, changes, groupCount, true);\n      _array_utils2.default.applyBatch(keyInfo, dataSource.items(), changes, groupCount, true);\n      changes.splice(0, changes.length);\n    },\n    _handlePush: function _handlePush(changes) {\n      this.push(changes, true);\n    },\n    _handleChanging: function _handleChanging(e) {\n      this.changing.fire(e);\n      this._applyBatch(e.changes);\n    },\n    _needCleanCacheByOperation: function _needCleanCacheByOperation(operationType, remoteOperations) {\n      var operationTypesByOrder = [\"filtering\", \"sorting\", \"paging\"],\n        operationTypeIndex = operationTypesByOrder.indexOf(operationType),\n        currentOperationTypes = operationTypeIndex >= 0 ? operationTypesByOrder.slice(operationTypeIndex) : [operationType];\n      return currentOperationTypes.some(function (operationType) {\n        return remoteOperations[operationType];\n      });\n    },\n    _customizeRemoteOperations: function _customizeRemoteOperations(options, isReload, operationTypes) {\n      var that = this,\n        cachedStoreData = that._cachedStoreData,\n        cachedPagingData = that._cachedPagingData,\n        cachedPagesData = that._cachedPagesData;\n      if (options.storeLoadOptions.filter && !options.remoteOperations.filtering || options.storeLoadOptions.sort && !options.remoteOperations.sorting) {\n        options.remoteOperations = {\n          filtering: options.remoteOperations.filtering\n        };\n      }\n      if (isReload) {\n        cachedStoreData = void 0;\n        cachedPagingData = void 0;\n        cachedPagesData = createEmptyPagesData();\n      } else {\n        if (operationTypes.reload) {\n          cachedPagingData = void 0;\n          cachedPagesData = createEmptyPagesData();\n        } else {\n          if (operationTypes.take || operationTypes.groupExpanding) {\n            cachedPagesData = createEmptyPagesData();\n          }\n        }\n        (0, _iterator.each)(operationTypes, function (operationType, value) {\n          if (value && that._needCleanCacheByOperation(operationType, options.remoteOperations)) {\n            cachedStoreData = void 0;\n            cachedPagingData = void 0;\n          }\n        });\n      }\n      if (cachedPagingData) {\n        options.remoteOperations.paging = false;\n      }\n      options.cachedStoreData = cachedStoreData;\n      options.cachedPagingData = cachedPagingData;\n      options.cachedPagesData = cachedPagesData;\n      if (!options.isCustomLoading) {\n        that._cachedStoreData = cachedStoreData;\n        that._cachedPagingData = cachedPagingData;\n        that._cachedPagesData = cachedPagesData;\n      }\n    },\n    _handleDataLoading: function _handleDataLoading(options) {\n      var loadOptions,\n        operationTypes,\n        that = this,\n        dataSource = that._dataSource,\n        lastLoadOptions = that._lastLoadOptions;\n      that.customizeStoreLoadOptions.fire(options);\n      options.delay = this.option(\"loadingTimeout\");\n      options.originalStoreLoadOptions = options.storeLoadOptions;\n      options.remoteOperations = (0, _extend.extend)({}, this.remoteOperations());\n      var isReload = !that.isLoaded() && !that._isRefreshing;\n      if (that.option(\"integrationOptions.renderedOnServer\") && !that.isLoaded()) {\n        options.delay = void 0;\n      }\n      loadOptions = (0, _extend.extend)({\n        pageIndex: that.pageIndex()\n      }, options.storeLoadOptions);\n      operationTypes = calculateOperationTypes(loadOptions, lastLoadOptions);\n      that._customizeRemoteOperations(options, isReload, operationTypes);\n      if (!options.isCustomLoading) {\n        var isRefreshing = that._isRefreshing;\n        options.pageIndex = dataSource.pageIndex();\n        options.lastLoadOptions = loadOptions;\n        options.operationTypes = operationTypes;\n        that._loadingOperationTypes = operationTypes;\n        that._isRefreshing = true;\n        (0, _deferred.when)(isRefreshing || that._isRefreshed || that.refresh(options, isReload, operationTypes)).done(function () {\n          if (that._lastOperationId === options.operationId) {\n            that._isRefreshed = true;\n            that.load().always(function () {\n              that._isRefreshed = false;\n            });\n          }\n        }).fail(function () {\n          dataSource.cancel(options.operationId);\n        }).always(function () {\n          that._isRefreshing = false;\n        });\n        dataSource.cancel(that._lastOperationId);\n        that._lastOperationId = options.operationId;\n        if (that._isRefreshing) {\n          dataSource.cancel(that._lastOperationId);\n        }\n      }\n      this._handleDataLoadingCore(options);\n    },\n    _handleDataLoadingCore: function _handleDataLoadingCore(options) {\n      var remoteOperations = options.remoteOperations;\n      options.loadOptions = {};\n      var cachedExtra = options.cachedPagesData.extra;\n      var localLoadOptionNames = {\n        filter: !remoteOperations.filtering,\n        sort: !remoteOperations.sorting,\n        group: !remoteOperations.grouping,\n        summary: !remoteOperations.summary,\n        skip: !remoteOperations.paging,\n        take: !remoteOperations.paging,\n        requireTotalCount: cachedExtra && \"totalCount\" in cachedExtra || !remoteOperations.paging\n      };\n      (0, _iterator.each)(options.storeLoadOptions, function (optionName, optionValue) {\n        if (localLoadOptionNames[optionName]) {\n          options.loadOptions[optionName] = optionValue;\n          delete options.storeLoadOptions[optionName];\n        }\n      });\n      if (cachedExtra) {\n        options.extra = cachedExtra;\n      }\n      options.data = getPageDataFromCache(options) || options.cachedStoreData;\n    },\n    _handleDataLoaded: function _handleDataLoaded(options) {\n      var _this2 = this;\n      var loadOptions = options.loadOptions,\n        localPaging = options.remoteOperations && !options.remoteOperations.paging,\n        cachedPagesData = options.cachedPagesData,\n        storeLoadOptions = options.storeLoadOptions,\n        needCache = false !== this.option(\"cacheEnabled\") && storeLoadOptions,\n        needPageCache = needCache && !options.isCustomLoading && cachedPagesData && (!localPaging || storeLoadOptions.group) && !this.option(\"legacyRendering\"),\n        needPagingCache = needCache && localPaging,\n        needStoreCache = needPagingCache && !options.isCustomLoading;\n      if (!loadOptions) {\n        this._dataSource.cancel(options.operationId);\n        return;\n      }\n      if (options.lastLoadOptions) {\n        this._lastLoadOptions = options.lastLoadOptions;\n        Object.keys(options.operationTypes).forEach(function (operationType) {\n          _this2._lastOperationTypes[operationType] = _this2._lastOperationTypes[operationType] || options.operationTypes[operationType];\n        });\n      }\n      if (localPaging) {\n        options.skip = loadOptions.skip;\n        options.take = loadOptions.take;\n        delete loadOptions.skip;\n        delete loadOptions.take;\n      }\n      if (loadOptions.group) {\n        loadOptions.group = options.group || loadOptions.group;\n      }\n      var groupCount = _uiData_grid2.default.normalizeSortingInfo(storeLoadOptions.group || loadOptions.group).length;\n      if (!needPageCache || !getPageDataFromCache(options)) {\n        if (needPagingCache && options.cachedPagingData) {\n          options.data = cloneItems(options.cachedPagingData, groupCount);\n        } else {\n          if (needStoreCache) {\n            if (!this._cachedStoreData) {\n              this._cachedStoreData = cloneItems(options.data, _uiData_grid2.default.normalizeSortingInfo(storeLoadOptions.group).length);\n            } else {\n              if (options.mergeStoreLoadData) {\n                options.data = this._cachedStoreData = this._cachedStoreData.concat(options.data);\n              }\n            }\n          }\n          new _array_store2.default(options.data).load(loadOptions).done(function (data) {\n            options.data = data;\n            if (needStoreCache) {\n              _this2._cachedPagingData = cloneItems(options.data, groupCount);\n            }\n          }).fail(function (error) {\n            options.data = new _deferred.Deferred().reject(error);\n          });\n        }\n        if (loadOptions.requireTotalCount && localPaging) {\n          options.extra = _type2.default.isPlainObject(options.extra) ? options.extra : {};\n          options.extra.totalCount = options.data.length;\n        }\n        if (options.extra && options.extra.totalCount >= 0 && (false === storeLoadOptions.requireTotalCount || false === loadOptions.requireTotalCount)) {\n          options.extra.totalCount = -1;\n        }\n        this._handleDataLoadedCore(options);\n        if (needPageCache) {\n          cachedPagesData.extra = cachedPagesData.extra || (0, _extend.extend)({}, options.extra);\n          (0, _deferred.when)(options.data).done(function (data) {\n            setPageDataToCache(options, cloneItems(data, groupCount));\n          });\n        }\n      }\n      options.storeLoadOptions = options.originalStoreLoadOptions;\n    },\n    _handleDataLoadedCore: function _handleDataLoadedCore(options) {\n      if (options.remoteOperations && !options.remoteOperations.paging && Array.isArray(options.data)) {\n        if (void 0 !== options.skip) {\n          options.data = options.data.slice(options.skip);\n        }\n        if (void 0 !== options.take) {\n          options.data = options.data.slice(0, options.take);\n        }\n      }\n    },\n    _handleLoadingChanged: function _handleLoadingChanged(isLoading) {\n      this.loadingChanged.fire(isLoading);\n    },\n    _handleLoadError: function _handleLoadError(error) {\n      this.loadError.fire(error);\n      this.changed.fire({\n        changeType: \"loadError\",\n        error: error\n      });\n    },\n    _handleDataChanged: function _handleDataChanged(args) {\n      var currentTotalCount,\n        that = this,\n        dataSource = that._dataSource,\n        isLoading = false,\n        itemsCount = that.itemsCount();\n      that._isLastPage = !itemsCount || !that.pageSize() || itemsCount < that.pageSize();\n      if (that._isLastPage) {\n        that._hasLastPage = true;\n      }\n      if (dataSource.totalCount() >= 0) {\n        if (dataSource.pageIndex() >= that.pageCount()) {\n          dataSource.pageIndex(that.pageCount() - 1);\n          that.pageIndex(dataSource.pageIndex());\n          that.resetPagesCache();\n          dataSource.load();\n          isLoading = true;\n        }\n      } else {\n        currentTotalCount = dataSource.pageIndex() * that.pageSize() + itemsCount;\n        that._currentTotalCount = Math.max(that._currentTotalCount, currentTotalCount);\n        if (0 === itemsCount && dataSource.pageIndex() >= that.pageCount()) {\n          dataSource.pageIndex(that.pageCount() - 1);\n          if (\"infinite\" !== that.option(\"scrolling.mode\")) {\n            dataSource.load();\n            isLoading = true;\n          }\n        }\n      }\n      if (!isLoading) {\n        that._operationTypes = that._lastOperationTypes;\n        that._lastOperationTypes = {};\n        that.component._optionCache = {};\n        that.changed.fire(args);\n        that.component._optionCache = void 0;\n      }\n    },\n    _scheduleCustomLoadCallbacks: function _scheduleCustomLoadCallbacks(deferred) {\n      var that = this;\n      that._isCustomLoading = true;\n      deferred.always(function () {\n        that._isCustomLoading = false;\n      });\n    },\n    loadingOperationTypes: function loadingOperationTypes() {\n      return this._loadingOperationTypes;\n    },\n    operationTypes: function operationTypes() {\n      return this._operationTypes;\n    },\n    isLastPage: function isLastPage() {\n      return this._isLastPage;\n    },\n    totalCount: function totalCount() {\n      return parseInt(this._currentTotalCount || this._dataSource.totalCount());\n    },\n    itemsCount: function itemsCount() {\n      return this._dataSource.items().length;\n    },\n    totalItemsCount: function totalItemsCount() {\n      return this.totalCount();\n    },\n    pageSize: function pageSize() {\n      var dataSource = this._dataSource;\n      if (!arguments.length && !dataSource.paginate()) {\n        return 0;\n      }\n      return dataSource.pageSize.apply(dataSource, arguments);\n    },\n    pageCount: function pageCount() {\n      var that = this,\n        count = that.totalItemsCount(),\n        pageSize = that.pageSize();\n      if (pageSize && count > 0) {\n        return Math.max(1, Math.ceil(count / pageSize));\n      }\n      return 1;\n    },\n    hasKnownLastPage: function hasKnownLastPage() {\n      return this._hasLastPage || this._dataSource.totalCount() >= 0;\n    },\n    loadFromStore: function loadFromStore(loadOptions) {\n      var dataSource = this._dataSource,\n        d = new _deferred.Deferred();\n      if (!dataSource) {\n        return;\n      }\n      dataSource.store().load(loadOptions).done(function (data, extra) {\n        if (data && !Array.isArray(data) && Array.isArray(data.data)) {\n          extra = data;\n          data = data.data;\n        }\n        d.resolve(data, extra);\n      }).fail(d.reject);\n      return d;\n    },\n    isCustomLoading: function isCustomLoading() {\n      return !!this._isCustomLoading;\n    },\n    load: function load(options) {\n      var store,\n        loadResult,\n        dataSourceLoadOptions,\n        that = this,\n        dataSource = that._dataSource,\n        d = new _deferred.Deferred();\n      if (options) {\n        store = dataSource.store();\n        dataSourceLoadOptions = dataSource.loadOptions();\n        loadResult = {\n          storeLoadOptions: options,\n          isCustomLoading: true\n        };\n        (0, _iterator.each)(store._customLoadOptions() || [], function (_, optionName) {\n          if (!(optionName in loadResult.storeLoadOptions)) {\n            loadResult.storeLoadOptions[optionName] = dataSourceLoadOptions[optionName];\n          }\n        });\n        that._scheduleCustomLoadCallbacks(d);\n        dataSource._scheduleLoadCallbacks(d);\n        that._handleDataLoading(loadResult);\n        executeTask(function () {\n          if (!dataSource.store()) {\n            return d.reject(\"canceled\");\n          }\n          (0, _deferred.when)(loadResult.data || that.loadFromStore(loadResult.storeLoadOptions)).done(function (data, extra) {\n            loadResult.data = data;\n            loadResult.extra = extra || {};\n            that._handleDataLoaded(loadResult);\n            if (options.requireTotalCount && void 0 === loadResult.extra.totalCount) {\n              loadResult.extra.totalCount = store.totalCount(loadResult.storeLoadOptions);\n            }\n            (0, _deferred.when)(loadResult.data, loadResult.extra.totalCount).done(function (data, totalCount) {\n              loadResult.extra.totalCount = totalCount;\n              d.resolve(data, loadResult.extra);\n            }).fail(d.reject);\n          }).fail(d.reject);\n        }, that.option(\"loadingTimeout\"));\n        return d.fail(function () {\n          that.fireEvent(\"loadError\", arguments);\n        }).promise();\n      } else {\n        return dataSource.load();\n      }\n    },\n    reload: function reload(full) {\n      return full ? this._dataSource.reload() : this._dataSource.load();\n    },\n    getCachedStoreData: function getCachedStoreData() {\n      return this._cachedStoreData;\n    }\n  };\n}());","map":null,"metadata":{},"sourceType":"script"}