{"ast":null,"code":"/**\r\n * DevExtreme (data/remote_query.js)\r\n * Version: 19.2.2\r\n * Build date: Tue Oct 01 2019\r\n *\r\n * Copyright (c) 2012 - 2019 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\n\"use strict\";\n\nvar queryAdapters = require(\"./query_adapters\"),\n  errorsModule = require(\"./errors\"),\n  each = require(\"../core/utils/iterator\").each,\n  isFunction = require(\"../core/utils/type\").isFunction,\n  Deferred = require(\"../core/utils/deferred\").Deferred,\n  arrayQueryImpl = require(\"./array_query\");\nvar remoteQueryImpl = function remoteQueryImpl(url, queryOptions, tasks) {\n  tasks = tasks || [];\n  queryOptions = queryOptions || {};\n  var createTask = function createTask(name, args) {\n    return {\n      name: name,\n      args: args\n    };\n  };\n  var exec = function exec(executorTask) {\n    var _adapterFactory,\n      _adapter,\n      _taskQueue,\n      _currentTask,\n      _mergedSortArgs,\n      d = new Deferred();\n    var rejectWithNotify = function rejectWithNotify(error) {\n      var handler = queryOptions.errorHandler;\n      if (handler) {\n        handler(error);\n      }\n      errorsModule._errorHandler(error);\n      d.reject(error);\n    };\n    function mergeSortTask(task) {\n      switch (task.name) {\n        case \"sortBy\":\n          _mergedSortArgs = [task.args];\n          return true;\n        case \"thenBy\":\n          if (!_mergedSortArgs) {\n            throw errorsModule.errors.Error(\"E4004\");\n          }\n          _mergedSortArgs.push(task.args);\n          return true;\n      }\n      return false;\n    }\n    function unmergeSortTasks() {\n      var head = _taskQueue[0],\n        unmergedTasks = [];\n      if (head && \"multiSort\" === head.name) {\n        _taskQueue.shift();\n        each(head.args[0], function () {\n          unmergedTasks.push(createTask(unmergedTasks.length ? \"thenBy\" : \"sortBy\", this));\n        });\n      }\n      _taskQueue = unmergedTasks.concat(_taskQueue);\n    }\n    try {\n      _adapterFactory = queryOptions.adapter;\n      if (!isFunction(_adapterFactory)) {\n        _adapterFactory = queryAdapters[_adapterFactory];\n      }\n      _adapter = _adapterFactory(queryOptions);\n      _taskQueue = [].concat(tasks).concat(executorTask);\n      var optimize = _adapter.optimize;\n      if (optimize) {\n        optimize(_taskQueue);\n      }\n      while (_taskQueue.length) {\n        _currentTask = _taskQueue[0];\n        if (!mergeSortTask(_currentTask)) {\n          if (_mergedSortArgs) {\n            _taskQueue.unshift(createTask(\"multiSort\", [_mergedSortArgs]));\n            _mergedSortArgs = null;\n            continue;\n          }\n          if (\"enumerate\" !== String(_currentTask.name)) {\n            if (!_adapter[_currentTask.name] || false === _adapter[_currentTask.name].apply(_adapter, _currentTask.args)) {\n              break;\n            }\n          }\n        }\n        _taskQueue.shift();\n      }\n      unmergeSortTasks();\n      _adapter.exec(url).done(function (result, extra) {\n        if (!_taskQueue.length) {\n          d.resolve(result, extra);\n        } else {\n          var clientChain = arrayQueryImpl(result, {\n            errorHandler: queryOptions.errorHandler\n          });\n          each(_taskQueue, function () {\n            clientChain = clientChain[this.name].apply(clientChain, this.args);\n          });\n          clientChain.done(d.resolve).fail(d.reject);\n        }\n      }).fail(rejectWithNotify);\n    } catch (x) {\n      rejectWithNotify(x);\n    }\n    return d.promise();\n  };\n  var query = {};\n  each([\"sortBy\", \"thenBy\", \"filter\", \"slice\", \"select\", \"groupBy\"], function () {\n    var name = String(this);\n    query[name] = function () {\n      return remoteQueryImpl(url, queryOptions, tasks.concat(createTask(name, arguments)));\n    };\n  });\n  each([\"count\", \"min\", \"max\", \"sum\", \"avg\", \"aggregate\", \"enumerate\"], function () {\n    var name = String(this);\n    query[name] = function () {\n      return exec.call(this, createTask(name, arguments));\n    };\n  });\n  return query;\n};\nmodule.exports = remoteQueryImpl;","map":null,"metadata":{},"sourceType":"script"}