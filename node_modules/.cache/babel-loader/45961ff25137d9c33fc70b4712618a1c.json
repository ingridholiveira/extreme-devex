{"ast":null,"code":"/**\r\n * DevExtreme (ui/editor/ui.data_expression.js)\r\n * Version: 19.2.2\r\n * Build date: Tue Oct 01 2019\r\n *\r\n * Copyright (c) 2012 - 2019 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\n\"use strict\";\n\nvar _typeof = \"function\" === typeof Symbol && \"symbol\" === typeof Symbol.iterator ? function (obj) {\n  return typeof obj;\n} : function (obj) {\n  return obj && \"function\" === typeof Symbol && obj.constructor === Symbol && obj !== Symbol.prototype ? \"symbol\" : typeof obj;\n};\nvar variableWrapper = require(\"../../core/utils/variable_wrapper\"),\n  dataCoreUtils = require(\"../../core/utils/data\"),\n  commonUtils = require(\"../../core/utils/common\"),\n  typeUtils = require(\"../../core/utils/type\"),\n  extend = require(\"../../core/utils/extend\").extend,\n  DataHelperMixin = require(\"../../data_helper\"),\n  DataSourceModule = require(\"../../data/data_source/data_source\"),\n  ArrayStore = require(\"../../data/array_store\"),\n  Deferred = require(\"../../core/utils/deferred\").Deferred;\nvar DataExpressionMixin = extend({}, DataHelperMixin, {\n  _dataExpressionDefaultOptions: function _dataExpressionDefaultOptions() {\n    return {\n      items: [],\n      dataSource: null,\n      itemTemplate: \"item\",\n      value: null,\n      valueExpr: \"this\",\n      displayExpr: void 0\n    };\n  },\n  _initDataExpressions: function _initDataExpressions() {\n    this._compileValueGetter();\n    this._compileDisplayGetter();\n    this._initDynamicTemplates();\n    this._initDataSource();\n    this._itemsToDataSource();\n  },\n  _itemsToDataSource: function _itemsToDataSource() {\n    if (!this.option(\"dataSource\")) {\n      this._dataSource = new DataSourceModule.DataSource({\n        store: new ArrayStore(this.option(\"items\")),\n        pageSize: 0\n      });\n    }\n  },\n  _compileDisplayGetter: function _compileDisplayGetter() {\n    this._displayGetter = dataCoreUtils.compileGetter(this._displayGetterExpr());\n  },\n  _displayGetterExpr: function _displayGetterExpr() {\n    return this.option(\"displayExpr\");\n  },\n  _compileValueGetter: function _compileValueGetter() {\n    this._valueGetter = dataCoreUtils.compileGetter(this._valueGetterExpr());\n  },\n  _valueGetterExpr: function _valueGetterExpr() {\n    return this.option(\"valueExpr\") || \"this\";\n  },\n  _loadValue: function _loadValue(value) {\n    var deferred = new Deferred();\n    value = this._unwrappedValue(value);\n    if (!typeUtils.isDefined(value)) {\n      return deferred.reject().promise();\n    }\n    this._loadSingle(this._valueGetterExpr(), value).done(function (item) {\n      this._isValueEquals(this._valueGetter(item), value) ? deferred.resolve(item) : deferred.reject();\n    }.bind(this)).fail(function () {\n      deferred.reject();\n    });\n    return deferred.promise();\n  },\n  _getCurrentValue: function _getCurrentValue() {\n    return this.option(\"value\");\n  },\n  _unwrappedValue: function _unwrappedValue(value) {\n    value = typeUtils.isDefined(value) ? value : this._getCurrentValue();\n    if (value && this._dataSource && \"this\" === this._valueGetterExpr()) {\n      value = this._getItemKey(value);\n    }\n    return variableWrapper.unwrap(value);\n  },\n  _getItemKey: function _getItemKey(value) {\n    var key = this._dataSource.key();\n    if (Array.isArray(key)) {\n      var result = {};\n      for (var i = 0, n = key.length; i < n; i++) {\n        result[key[i]] = value[key[i]];\n      }\n      return result;\n    }\n    if (key && \"object\" === (\"undefined\" === typeof value ? \"undefined\" : _typeof(value))) {\n      value = value[key];\n    }\n    return value;\n  },\n  _isValueEquals: function _isValueEquals(value1, value2) {\n    var dataSourceKey = this._dataSource && this._dataSource.key();\n    var isDefined = typeUtils.isDefined;\n    var result = this._compareValues(value1, value2);\n    if (!result && dataSourceKey && isDefined(value1) && isDefined(value2)) {\n      if (Array.isArray(dataSourceKey)) {\n        result = this._compareByCompositeKey(value1, value2, dataSourceKey);\n      } else {\n        result = this._compareByKey(value1, value2, dataSourceKey);\n      }\n    }\n    return result;\n  },\n  _compareByCompositeKey: function _compareByCompositeKey(value1, value2, key) {\n    var isObject = typeUtils.isObject;\n    if (!isObject(value1) || !isObject(value2)) {\n      return false;\n    }\n    for (var i = 0, n = key.length; i < n; i++) {\n      if (value1[key[i]] !== value2[key[i]]) {\n        return false;\n      }\n    }\n    return true;\n  },\n  _compareByKey: function _compareByKey(value1, value2, key) {\n    var ensureDefined = commonUtils.ensureDefined;\n    var unwrapObservable = variableWrapper.unwrap;\n    var valueKey1 = ensureDefined(unwrapObservable(value1[key]), value1);\n    var valueKey2 = ensureDefined(unwrapObservable(value2[key]), value2);\n    return this._compareValues(valueKey1, valueKey2);\n  },\n  _compareValues: function _compareValues(value1, value2) {\n    return dataCoreUtils.toComparable(value1, true) === dataCoreUtils.toComparable(value2, true);\n  },\n  _initDynamicTemplates: commonUtils.noop,\n  _setCollectionWidgetItemTemplate: function _setCollectionWidgetItemTemplate() {\n    this._initDynamicTemplates();\n    this._setCollectionWidgetOption(\"itemTemplate\", this.option(\"itemTemplate\"));\n  },\n  _getCollectionKeyExpr: function _getCollectionKeyExpr() {\n    var valueExpr = this.option(\"valueExpr\");\n    var isValueExprField = typeUtils.isString(valueExpr) && \"this\" !== valueExpr || typeUtils.isFunction(valueExpr);\n    return isValueExprField ? valueExpr : null;\n  },\n  _dataExpressionOptionChanged: function _dataExpressionOptionChanged(args) {\n    switch (args.name) {\n      case \"items\":\n        this._itemsToDataSource();\n        this._setCollectionWidgetOption(\"items\");\n        break;\n      case \"dataSource\":\n        this._initDataSource();\n        break;\n      case \"itemTemplate\":\n        this._setCollectionWidgetItemTemplate();\n        break;\n      case \"valueExpr\":\n        this._compileValueGetter();\n        break;\n      case \"displayExpr\":\n        this._compileDisplayGetter();\n        this._initDynamicTemplates();\n        this._setCollectionWidgetOption(\"displayExpr\");\n    }\n  }\n});\nmodule.exports = DataExpressionMixin;","map":null,"metadata":{},"sourceType":"script"}