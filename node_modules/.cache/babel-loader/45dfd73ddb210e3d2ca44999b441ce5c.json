{"ast":null,"code":"/**\r\n * DevExtreme (data/array_utils.js)\r\n * Version: 19.2.2\r\n * Build date: Tue Oct 01 2019\r\n *\r\n * Copyright (c) 2012 - 2019 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\n\"use strict\";\n\nvar _typeof = \"function\" === typeof Symbol && \"symbol\" === typeof Symbol.iterator ? function (obj) {\n  return typeof obj;\n} : function (obj) {\n  return obj && \"function\" === typeof Symbol && obj.constructor === Symbol && obj !== Symbol.prototype ? \"symbol\" : typeof obj;\n};\nvar _type = require(\"../core/utils/type\");\nvar _config = require(\"../core/config\");\nvar _config2 = _interopRequireDefault(_config);\nvar _guid = require(\"../core/guid\");\nvar _guid2 = _interopRequireDefault(_guid);\nvar _extend = require(\"../core/utils/extend\");\nvar _errors = require(\"./errors\");\nvar _object = require(\"../core/utils/object\");\nvar _object2 = _interopRequireDefault(_object);\nvar _utils = require(\"./utils\");\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    \"default\": obj\n  };\n}\nfunction hasKey(target, keyOrKeys) {\n  var key,\n    keys = \"string\" === typeof keyOrKeys ? keyOrKeys.split() : keyOrKeys.slice();\n  while (keys.length) {\n    key = keys.shift();\n    if (key in target) {\n      return true;\n    }\n  }\n  return false;\n}\nfunction findItems(keyInfo, items, key, groupCount) {\n  var childItems, result;\n  if (groupCount) {\n    for (var i = 0; i < items.length; i++) {\n      childItems = items[i].items || items[i].collapsedItems || [];\n      result = findItems(keyInfo, childItems || [], key, groupCount - 1);\n      if (result) {\n        return result;\n      }\n    }\n  } else {\n    if (indexByKey(keyInfo, items, key) >= 0) {\n      return items;\n    }\n  }\n}\nfunction getItems(keyInfo, items, key, groupCount) {\n  if (groupCount) {\n    return findItems(keyInfo, items, key, groupCount) || [];\n  }\n  return items;\n}\nfunction generateDataByKeyMap(keyInfo, array) {\n  if (keyInfo.key() && !array._dataByKeyMap) {\n    var dataByKeyMap = {};\n    for (var i = 0, arrayLength = array.length; i < arrayLength; i++) {\n      dataByKeyMap[JSON.stringify(keyInfo.keyOf(array[i]))] = array[i];\n    }\n    array._dataByKeyMap = dataByKeyMap;\n  }\n}\nfunction getCacheValue(array, key) {\n  if (array._dataByKeyMap) {\n    return array._dataByKeyMap[JSON.stringify(key)];\n  }\n}\nfunction getHasKeyCacheValue(array, key) {\n  if (array._dataByKeyMap) {\n    return array._dataByKeyMap[JSON.stringify(key)];\n  }\n  return true;\n}\nfunction setDataByKeyMapValue(array, key, data) {\n  if (array._dataByKeyMap) {\n    array._dataByKeyMap[JSON.stringify(key)] = data;\n  }\n}\nfunction applyBatch(keyInfo, array, batchData, groupCount, useInsertIndex) {\n  batchData.forEach(function (item) {\n    var items = \"insert\" === item.type ? array : getItems(keyInfo, array, item.key, groupCount);\n    generateDataByKeyMap(keyInfo, items);\n    switch (item.type) {\n      case \"update\":\n        update(keyInfo, items, item.key, item.data, true);\n        break;\n      case \"insert\":\n        insert(keyInfo, items, item.data, useInsertIndex && (0, _type.isDefined)(item.index) ? item.index : -1, true);\n        break;\n      case \"remove\":\n        remove(keyInfo, items, item.key, true);\n    }\n  });\n}\nfunction update(keyInfo, array, key, data, isBatch) {\n  var target,\n    extendComplexObject = true,\n    keyExpr = keyInfo.key();\n  if (keyExpr) {\n    if (hasKey(data, keyExpr) && !(0, _utils.keysEqual)(keyExpr, key, keyInfo.keyOf(data))) {\n      return !isBatch && (0, _utils.rejectedPromise)(_errors.errors.Error(\"E4017\"));\n    }\n    target = getCacheValue(array, key);\n    if (!target) {\n      var index = indexByKey(keyInfo, array, key);\n      if (index < 0) {\n        return !isBatch && (0, _utils.rejectedPromise)(_errors.errors.Error(\"E4009\"));\n      }\n      target = array[index];\n    }\n  } else {\n    target = key;\n  }\n  _object2.default.deepExtendArraySafe(target, data, extendComplexObject);\n  if (!isBatch) {\n    if ((0, _config2.default)().useLegacyStoreResult) {\n      return (0, _utils.trivialPromise)(key, data);\n    } else {\n      return (0, _utils.trivialPromise)(target, key);\n    }\n  }\n}\nfunction insert(keyInfo, array, data, index, isBatch) {\n  var keyValue,\n    obj,\n    keyExpr = keyInfo.key();\n  obj = (0, _type.isPlainObject)(data) ? (0, _extend.extend)({}, data) : data;\n  if (keyExpr) {\n    keyValue = keyInfo.keyOf(obj);\n    if (void 0 === keyValue || \"object\" === (\"undefined\" === typeof keyValue ? \"undefined\" : _typeof(keyValue)) && (0, _type.isEmptyObject)(keyValue)) {\n      if (Array.isArray(keyExpr)) {\n        throw _errors.errors.Error(\"E4007\");\n      }\n      keyValue = obj[keyExpr] = String(new _guid2.default());\n    } else {\n      if (void 0 !== array[indexByKey(keyInfo, array, keyValue)]) {\n        return !isBatch && (0, _utils.rejectedPromise)(_errors.errors.Error(\"E4008\"));\n      }\n    }\n  } else {\n    keyValue = obj;\n  }\n  if (index >= 0) {\n    array.splice(index, 0, obj);\n  } else {\n    array.push(obj);\n  }\n  setDataByKeyMapValue(array, keyValue, obj);\n  if (!isBatch) {\n    return (0, _utils.trivialPromise)((0, _config2.default)().useLegacyStoreResult ? data : obj, keyValue);\n  }\n}\nfunction remove(keyInfo, array, key, isBatch) {\n  var index = indexByKey(keyInfo, array, key);\n  if (index > -1) {\n    array.splice(index, 1);\n  }\n  if (!isBatch) {\n    return (0, _utils.trivialPromise)(key);\n  }\n}\nfunction indexByKey(keyInfo, array, key) {\n  var keyExpr = keyInfo.key();\n  if (!getHasKeyCacheValue(array, key)) {\n    return -1;\n  }\n  for (var i = 0, arrayLength = array.length; i < arrayLength; i++) {\n    if ((0, _utils.keysEqual)(keyExpr, keyInfo.keyOf(array[i]), key)) {\n      return i;\n    }\n  }\n  return -1;\n}\nmodule.exports.applyBatch = applyBatch;\nmodule.exports.update = update;\nmodule.exports.insert = insert;\nmodule.exports.remove = remove;\nmodule.exports.indexByKey = indexByKey;","map":null,"metadata":{},"sourceType":"script"}