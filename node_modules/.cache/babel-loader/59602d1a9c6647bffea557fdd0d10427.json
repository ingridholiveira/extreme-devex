{"ast":null,"code":"/**\r\n * DevExtreme (ui/date_box/ui.date_box.base.js)\r\n * Version: 19.2.2\r\n * Build date: Tue Oct 01 2019\r\n *\r\n * Copyright (c) 2012 - 2019 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\n\"use strict\";\n\nvar windowUtils = require(\"../../core/utils/window\"),\n  window = windowUtils.getWindow(),\n  registerComponent = require(\"../../core/component_registrator\"),\n  typeUtils = require(\"../../core/utils/type\"),\n  dom = require(\"../../core/utils/dom\"),\n  each = require(\"../../core/utils/iterator\").each,\n  compareVersions = require(\"../../core/utils/version\").compare,\n  extend = require(\"../../core/utils/extend\").extend,\n  support = require(\"../../core/utils/support\"),\n  devices = require(\"../../core/devices\"),\n  config = require(\"../../core/config\"),\n  dateUtils = require(\"../../core/utils/date\"),\n  uiDateUtils = require(\"./ui.date_utils\"),\n  dateSerialization = require(\"../../core/utils/date_serialization\"),\n  DropDownEditor = require(\"../drop_down_editor/ui.drop_down_editor\"),\n  dateLocalization = require(\"../../localization/date\"),\n  messageLocalization = require(\"../../localization/message\"),\n  DATEBOX_CLASS = \"dx-datebox\",\n  DX_AUTO_WIDTH_CLASS = \"dx-auto-width\",\n  DATEBOX_WRAPPER_CLASS = \"dx-datebox-wrapper\";\nvar PICKER_TYPE = {\n  calendar: \"calendar\",\n  rollers: \"rollers\",\n  list: \"list\",\n  \"native\": \"native\"\n};\nvar TYPE = {\n  date: \"date\",\n  datetime: \"datetime\",\n  time: \"time\"\n};\nvar STRATEGY_NAME = {\n  calendar: \"Calendar\",\n  dateView: \"DateView\",\n  \"native\": \"Native\",\n  calendarWithTime: \"CalendarWithTime\",\n  list: \"List\"\n};\nvar STRATEGY_CLASSES = {\n  Calendar: require(\"./ui.date_box.strategy.calendar\"),\n  DateView: require(\"./ui.date_box.strategy.date_view\"),\n  Native: require(\"./ui.date_box.strategy.native\"),\n  CalendarWithTime: require(\"./ui.date_box.strategy.calendar_with_time\"),\n  List: require(\"./ui.date_box.strategy.list\")\n};\nvar isRealWidthSet = function isRealWidthSet($element) {\n  var explicitWidth = $element[0].style.width;\n  if (explicitWidth && \"auto\" !== explicitWidth && \"inherit\" !== explicitWidth) {\n    return true;\n  }\n  return false;\n};\nvar DateBox = DropDownEditor.inherit({\n  _supportedKeys: function _supportedKeys() {\n    return extend(this.callBase(), this._strategy.supportedKeys());\n  },\n  _setDeprecatedOptions: function _setDeprecatedOptions() {\n    this.callBase();\n    extend(this._deprecatedOptions, {\n      maxZoomLevel: {\n        since: \"18.1\",\n        alias: \"calendarOptions.maxZoomLevel\"\n      },\n      minZoomLevel: {\n        since: \"18.1\",\n        alias: \"calendarOptions.minZoomLevel\"\n      }\n    });\n  },\n  _getDefaultOptions: function _getDefaultOptions() {\n    return extend(this.callBase(), {\n      type: \"date\",\n      showAnalogClock: true,\n      value: null,\n      dateSerializationFormat: void 0,\n      min: void 0,\n      max: void 0,\n      displayFormat: null,\n      interval: 30,\n      disabledDates: null,\n      maxZoomLevel: \"month\",\n      minZoomLevel: \"century\",\n      pickerType: PICKER_TYPE.calendar,\n      invalidDateMessage: messageLocalization.format(\"dxDateBox-validation-datetime\"),\n      dateOutOfRangeMessage: messageLocalization.format(\"validation-range\"),\n      applyButtonText: messageLocalization.format(\"OK\"),\n      adaptivityEnabled: false,\n      calendarOptions: {},\n      useHiddenSubmitElement: true\n    });\n  },\n  _defaultOptionsRules: function _defaultOptionsRules() {\n    return this.callBase().concat([{\n      device: {\n        platform: \"ios\"\n      },\n      options: {\n        showPopupTitle: true\n      }\n    }, {\n      device: {\n        platform: \"android\"\n      },\n      options: {\n        buttonsLocation: \"bottom after\"\n      }\n    }, {\n      device: function device() {\n        var realDevice = devices.real(),\n          platform = realDevice.platform;\n        return \"ios\" === platform || \"android\" === platform;\n      },\n      options: {\n        pickerType: PICKER_TYPE.native\n      }\n    }, {\n      device: function device(currentDevice) {\n        var realDevice = devices.real(),\n          platform = realDevice.platform,\n          version = realDevice.version;\n        return \"generic\" === platform && \"desktop\" !== currentDevice.deviceType || \"android\" === platform && compareVersions(version, [4, 4]) < 0;\n      },\n      options: {\n        pickerType: PICKER_TYPE.rollers\n      }\n    }, {\n      device: {\n        platform: \"generic\",\n        deviceType: \"desktop\"\n      },\n      options: {\n        buttonsLocation: \"bottom after\"\n      }\n    }]);\n  },\n  _initOptions: function _initOptions(options) {\n    this._userOptions = extend({}, options);\n    this.callBase(options);\n    this._updatePickerOptions();\n  },\n  _updatePickerOptions: function _updatePickerOptions() {\n    var pickerType = this.option(\"pickerType\");\n    var type = this.option(\"type\");\n    if (pickerType === PICKER_TYPE.list && (type === TYPE.datetime || type === TYPE.date)) {\n      pickerType = PICKER_TYPE.calendar;\n    }\n    if (type === TYPE.time && pickerType === PICKER_TYPE.calendar) {\n      pickerType = PICKER_TYPE.list;\n    }\n    this.option(\"showDropDownButton\", \"generic\" !== devices.real().platform || pickerType !== PICKER_TYPE.native);\n    this._pickerType = pickerType;\n  },\n  _init: function _init() {\n    this._initStrategy();\n    this.option(extend({}, this._strategy.getDefaultOptions(), this._userOptions));\n    delete this._userOptions;\n    this.callBase();\n  },\n  _toLowerCaseFirstLetter: function _toLowerCaseFirstLetter(string) {\n    return string.charAt(0).toLowerCase() + string.substr(1);\n  },\n  _initStrategy: function _initStrategy() {\n    var strategyName = this._getStrategyName(this._getFormatType()),\n      strategy = STRATEGY_CLASSES[strategyName];\n    if (!(this._strategy && this._strategy.NAME === strategyName)) {\n      this._strategy = new strategy(this);\n    }\n  },\n  _getFormatType: function _getFormatType() {\n    var currentType = this.option(\"type\");\n    var isTime = /h|m|s/g.test(currentType),\n      isDate = /d|M|Y/g.test(currentType);\n    var type = \"\";\n    if (isDate) {\n      type += TYPE.date;\n    }\n    if (isTime) {\n      type += TYPE.time;\n    }\n    return type;\n  },\n  _getStrategyName: function _getStrategyName(type) {\n    var pickerType = this._pickerType;\n    if (pickerType === PICKER_TYPE.rollers) {\n      return STRATEGY_NAME.dateView;\n    } else {\n      if (pickerType === PICKER_TYPE.native) {\n        return STRATEGY_NAME.native;\n      }\n    }\n    if (type === TYPE.date) {\n      return STRATEGY_NAME.calendar;\n    }\n    if (type === TYPE.datetime) {\n      return STRATEGY_NAME.calendarWithTime;\n    }\n    return STRATEGY_NAME.list;\n  },\n  _initMarkup: function _initMarkup() {\n    this.$element().addClass(DATEBOX_CLASS);\n    this.callBase();\n    this._refreshFormatClass();\n    this._refreshPickerTypeClass();\n    this._strategy.renderInputMinMax(this._input());\n  },\n  _render: function _render() {\n    this.callBase();\n    this._updateSize();\n  },\n  _renderDimensions: function _renderDimensions() {\n    this.callBase();\n    this.$element().toggleClass(DX_AUTO_WIDTH_CLASS, !this.option(\"width\"));\n  },\n  _refreshFormatClass: function _refreshFormatClass() {\n    var $element = this.$element();\n    each(TYPE, function (_, item) {\n      $element.removeClass(DATEBOX_CLASS + \"-\" + item);\n    });\n    $element.addClass(DATEBOX_CLASS + \"-\" + this.option(\"type\"));\n  },\n  _refreshPickerTypeClass: function _refreshPickerTypeClass() {\n    var $element = this.$element();\n    each(PICKER_TYPE, function (_, item) {\n      $element.removeClass(DATEBOX_CLASS + \"-\" + item);\n    });\n    $element.addClass(DATEBOX_CLASS + \"-\" + this._pickerType);\n  },\n  _updateSize: function _updateSize() {\n    var $element = this.$element(),\n      widthOption = this.option(\"width\"),\n      isWidthSet = typeUtils.isDefined(widthOption) || isRealWidthSet($element) && !this._isSizeUpdatable,\n      pickerType = this._pickerType,\n      shouldCalculateWidth = pickerType !== PICKER_TYPE.rollers && \"generic\" === devices.current().platform;\n    if (!windowUtils.hasWindow() || isWidthSet || !(shouldCalculateWidth && $element.is(\":visible\"))) {\n      return;\n    }\n    var format = this._strategy.getDisplayFormat(this.option(\"displayFormat\")),\n      longestValue = dateLocalization.format(uiDateUtils.getLongestDate(format, dateLocalization.getMonthNames(), dateLocalization.getDayNames()), format);\n    $element.width(this._calculateWidth(longestValue));\n    this._isSizeUpdatable = true;\n  },\n  _calculateWidth: function _calculateWidth(value) {\n    var IE_ROUNDING_ERROR = 10;\n    var NATIVE_BUTTONS_WIDTH = 48;\n    var $input = this._input();\n    var $longestValueElement = dom.createTextElementHiddenCopy($input, value);\n    $longestValueElement.appendTo(this.$element());\n    var elementWidth = parseFloat(window.getComputedStyle($longestValueElement.get(0)).width),\n      rightPadding = parseFloat(window.getComputedStyle($input.get(0)).paddingRight),\n      leftPadding = parseFloat(window.getComputedStyle($input.get(0)).paddingLeft),\n      beforeButtonsWidth = this._$beforeButtonsContainer ? parseFloat(window.getComputedStyle(this._$beforeButtonsContainer.get(0)).width) : 0,\n      afterButtonsWidth = this._$afterButtonsContainer ? parseFloat(window.getComputedStyle(this._$afterButtonsContainer.get(0)).width) : 0;\n    var width = elementWidth + rightPadding + leftPadding + IE_ROUNDING_ERROR + beforeButtonsWidth + afterButtonsWidth + (\"text\" !== $input.prop(\"type\") ? NATIVE_BUTTONS_WIDTH : 0);\n    $longestValueElement.remove();\n    return width;\n  },\n  _attachChildKeyboardEvents: function _attachChildKeyboardEvents() {\n    this._strategy.attachKeyboardEvents(this._keyboardProcessor);\n  },\n  _renderPopup: function _renderPopup() {\n    this.callBase();\n    this._popup._wrapper().addClass(DATEBOX_WRAPPER_CLASS);\n    this._renderPopupWrapper();\n  },\n  _popupConfig: function _popupConfig() {\n    var popupConfig = this.callBase();\n    return extend(this._strategy.popupConfig(popupConfig), {\n      title: this._getPopupTitle(),\n      dragEnabled: false\n    });\n  },\n  _renderPopupWrapper: function _renderPopupWrapper() {\n    if (!this._popup) {\n      return;\n    }\n    var $element = this.$element();\n    var classPostfixes = extend({}, TYPE, PICKER_TYPE);\n    each(classPostfixes, function (_, item) {\n      $element.removeClass(DATEBOX_WRAPPER_CLASS + \"-\" + item);\n    }.bind(this));\n    this._popup._wrapper().addClass(DATEBOX_WRAPPER_CLASS + \"-\" + this.option(\"type\")).addClass(DATEBOX_WRAPPER_CLASS + \"-\" + this._pickerType);\n  },\n  _renderPopupContent: function _renderPopupContent() {\n    this.callBase();\n    this._strategy.renderPopupContent();\n  },\n  _getFirstPopupElement: function _getFirstPopupElement() {\n    return this._strategy.getFirstPopupElement() || this.callBase();\n  },\n  _getLastPopupElement: function _getLastPopupElement() {\n    return this._strategy.getLastPopupElement() || this.callBase();\n  },\n  _popupShowingHandler: function _popupShowingHandler() {\n    this.callBase();\n    this._strategy.popupShowingHandler();\n  },\n  _popupHiddenHandler: function _popupHiddenHandler() {\n    this.callBase();\n    this._strategy.popupHiddenHandler();\n  },\n  _visibilityChanged: function _visibilityChanged(visible) {\n    if (visible) {\n      this._updateSize();\n    }\n  },\n  _clearValueHandler: function _clearValueHandler(e) {\n    this.option(\"text\", \"\");\n    this.callBase(e);\n  },\n  _readOnlyPropValue: function _readOnlyPropValue() {\n    if (this._pickerType === PICKER_TYPE.rollers) {\n      return true;\n    }\n    var platform = devices.real().platform,\n      isCustomValueDisabled = this._isNativeType() && (\"ios\" === platform || \"android\" === platform);\n    if (isCustomValueDisabled) {\n      return this.option(\"readOnly\");\n    }\n    return this.callBase();\n  },\n  _isClearButtonVisible: function _isClearButtonVisible() {\n    return this.callBase() && !this._isNativeType();\n  },\n  _renderValue: function _renderValue() {\n    var value = this.dateOption(\"value\");\n    this.option(\"text\", this._getDisplayedText(value));\n    this._strategy.renderValue();\n    return this.callBase();\n  },\n  _setSubmitValue: function _setSubmitValue() {\n    var value = this.dateOption(\"value\");\n    var dateSerializationFormat = this.option(\"dateSerializationFormat\");\n    var submitFormat = uiDateUtils.SUBMIT_FORMATS_MAP[this.option(\"type\")];\n    var submitValue = dateSerializationFormat ? dateSerialization.serializeDate(value, dateSerializationFormat) : uiDateUtils.toStandardDateFormat(value, submitFormat);\n    this._getSubmitElement().val(submitValue);\n  },\n  _getDisplayedText: function _getDisplayedText(value) {\n    var displayedText,\n      mode = this.option(\"mode\");\n    if (\"text\" === mode) {\n      var displayFormat = this._strategy.getDisplayFormat(this.option(\"displayFormat\"));\n      displayedText = dateLocalization.format(value, displayFormat);\n    } else {\n      var format = this._getFormatByMode(mode);\n      if (format) {\n        displayedText = dateLocalization.format(value, format);\n      } else {\n        displayedText = uiDateUtils.toStandardDateFormat(value, mode);\n      }\n    }\n    return displayedText;\n  },\n  _getFormatByMode: function _getFormatByMode(mode) {\n    return support.inputType(mode) ? null : uiDateUtils.FORMATS_MAP[mode];\n  },\n  _valueChangeEventHandler: function _valueChangeEventHandler(e) {\n    var text = this.option(\"text\"),\n      currentValue = this.dateOption(\"value\");\n    if (text === this._getDisplayedText(currentValue)) {\n      this._validateValue(currentValue);\n      return;\n    }\n    var parsedDate = this._getParsedDate(text),\n      value = currentValue || this._getDateByDefault(),\n      type = this.option(\"type\"),\n      newValue = uiDateUtils.mergeDates(value, parsedDate, type),\n      date = parsedDate && \"time\" === type ? newValue : parsedDate;\n    if (this._applyInternalValidation(date)) {\n      var displayedText = this._getDisplayedText(newValue);\n      if (value && newValue && value.getTime() === newValue.getTime() && displayedText !== text) {\n        this._renderValue();\n      } else {\n        this.dateValue(newValue, e);\n      }\n    }\n    this._applyCustomValidation(newValue);\n  },\n  _getDateByDefault: function _getDateByDefault() {\n    return this._strategy.useCurrentDateByDefault() && this._strategy.getDefaultDate();\n  },\n  _getParsedDate: function _getParsedDate(text) {\n    var displayFormat = this._strategy.getDisplayFormat(this.option(\"displayFormat\"));\n    var parsedText = this._strategy.getParsedText(text, displayFormat);\n    return typeUtils.isDefined(parsedText) ? parsedText : void 0;\n  },\n  _validateValue: function _validateValue(value) {\n    return this._applyInternalValidation(value) && this._applyCustomValidation(value);\n  },\n  _applyInternalValidation: function _applyInternalValidation(value) {\n    var text = this.option(\"text\"),\n      hasText = !!text && null !== value,\n      isDate = !!value && typeUtils.isDate(value) && !isNaN(value.getTime()),\n      isDateInRange = isDate && dateUtils.dateInRange(value, this.dateOption(\"min\"), this.dateOption(\"max\"), this.option(\"type\")),\n      isValid = !hasText && !value || isDateInRange,\n      validationMessage = \"\";\n    if (!isDate) {\n      validationMessage = this.option(\"invalidDateMessage\");\n    } else {\n      if (!isDateInRange) {\n        validationMessage = this.option(\"dateOutOfRangeMessage\");\n      }\n    }\n    this.option({\n      isValid: isValid,\n      validationError: isValid ? null : {\n        editorSpecific: true,\n        message: validationMessage\n      }\n    });\n    return isValid;\n  },\n  _applyCustomValidation: function _applyCustomValidation(value) {\n    this.validationRequest.fire({\n      editor: this,\n      value: value\n    });\n    return this.option(\"isValid\");\n  },\n  _isValueChanged: function _isValueChanged(newValue) {\n    var oldValue = this.dateOption(\"value\"),\n      oldTime = oldValue && oldValue.getTime(),\n      newTime = newValue && newValue.getTime();\n    return oldTime !== newTime;\n  },\n  _isTextChanged: function _isTextChanged(newValue) {\n    var oldText = this.option(\"text\"),\n      newText = newValue && this._getDisplayedText(newValue) || \"\";\n    return oldText !== newText;\n  },\n  _renderProps: function _renderProps() {\n    this.callBase();\n    this._input().attr(\"autocomplete\", \"off\");\n  },\n  _renderOpenedState: function _renderOpenedState() {\n    if (!this._isNativeType()) {\n      this.callBase();\n    }\n    if (this._strategy.isAdaptivityChanged()) {\n      this._refreshStrategy();\n    }\n    this._strategy.renderOpenedState();\n  },\n  _getPopupTitle: function _getPopupTitle() {\n    var placeholder = this.option(\"placeholder\");\n    if (placeholder) {\n      return placeholder;\n    }\n    var type = this.option(\"type\");\n    if (type === TYPE.time) {\n      return messageLocalization.format(\"dxDateBox-simulatedDataPickerTitleTime\");\n    }\n    if (type === TYPE.date || type === TYPE.datetime) {\n      return messageLocalization.format(\"dxDateBox-simulatedDataPickerTitleDate\");\n    }\n    return \"\";\n  },\n  _renderPlaceholder: function _renderPlaceholder() {\n    this._popup && this._popup.option(\"title\", this._getPopupTitle());\n    this.callBase();\n  },\n  _refreshStrategy: function _refreshStrategy() {\n    this._strategy.dispose();\n    this._initStrategy();\n    this.option(this._strategy.getDefaultOptions());\n    this._refresh();\n  },\n  _applyButtonHandler: function _applyButtonHandler(e) {\n    var value = this._strategy.getValue();\n    if (this._validateValue(value)) {\n      this.dateValue(value, e.event);\n    }\n    this.callBase();\n  },\n  _dispose: function _dispose() {\n    this._strategy && this._strategy.dispose();\n    this.callBase();\n  },\n  _isNativeType: function _isNativeType() {\n    return this._pickerType === PICKER_TYPE.native;\n  },\n  _optionChanged: function _optionChanged(args) {\n    switch (args.name) {\n      case \"showClearButton\":\n      case \"buttons\":\n        this.callBase.apply(this, arguments);\n        this._updateSize();\n        break;\n      case \"pickerType\":\n        this._updatePickerOptions({\n          pickerType: args.value\n        });\n        this._refreshStrategy();\n        this._refreshPickerTypeClass();\n        this._invalidate();\n        break;\n      case \"type\":\n        this._updatePickerOptions({\n          format: args.value\n        });\n        this._refreshStrategy();\n        this._refreshFormatClass();\n        this._renderPopupWrapper();\n        this._updateSize();\n        break;\n      case \"placeholder\":\n        this._renderPlaceholder();\n        break;\n      case \"min\":\n      case \"max\":\n        this._applyInternalValidation(this.dateOption(\"value\"));\n        this._invalidate();\n        break;\n      case \"dateSerializationFormat\":\n      case \"interval\":\n      case \"disabledDates\":\n      case \"calendarOptions\":\n      case \"minZoomLevel\":\n      case \"maxZoomLevel\":\n        this._invalidate();\n        break;\n      case \"displayFormat\":\n        this.option(\"text\", this._getDisplayedText(this.dateOption(\"value\")));\n        this._renderInputValue();\n        break;\n      case \"formatWidthCalculator\":\n        break;\n      case \"closeOnValueChange\":\n        var applyValueMode = args.value ? \"instantly\" : \"useButtons\";\n        this.option(\"applyValueMode\", applyValueMode);\n        break;\n      case \"applyValueMode\":\n        this._suppressDeprecatedWarnings();\n        this.option(\"closeOnValueChange\", \"instantly\" === args.value);\n        this._resumeDeprecatedWarnings();\n        this.callBase.apply(this, arguments);\n        break;\n      case \"text\":\n        this._strategy.textChangedHandler(args.value);\n        this.callBase.apply(this, arguments);\n        break;\n      case \"isValid\":\n        this.callBase.apply(this, arguments);\n        this._updateSize();\n        break;\n      case \"showDropDownButton\":\n        this._updateSize();\n        break;\n      case \"readOnly\":\n        this.callBase.apply(this, arguments);\n        this._updateSize();\n        break;\n      case \"invalidDateMessage\":\n      case \"dateOutOfRangeMessage\":\n      case \"adaptivityEnabled\":\n      case \"showAnalogClock\":\n        break;\n      default:\n        this.callBase.apply(this, arguments);\n    }\n  },\n  _getSerializationFormat: function _getSerializationFormat() {\n    var value = this.option(\"value\");\n    if (this.option(\"dateSerializationFormat\") && config().forceIsoDateParsing) {\n      return this.option(\"dateSerializationFormat\");\n    }\n    if (typeUtils.isNumeric(value)) {\n      return \"number\";\n    }\n    if (!typeUtils.isString(value)) {\n      return;\n    }\n    return dateSerialization.getDateSerializationFormat(value);\n  },\n  _updateValue: function _updateValue(value) {\n    this.callBase();\n    this._validateValue(value || this.dateOption(\"value\"));\n  },\n  dateValue: function dateValue(value, dxEvent) {\n    var isValueChanged = this._isValueChanged(value);\n    if (isValueChanged && dxEvent) {\n      this._saveValueChangeEvent(dxEvent);\n    }\n    if (!isValueChanged && this._isTextChanged(value)) {\n      this._updateValue(value);\n    }\n    return this.dateOption(\"value\", value);\n  },\n  dateOption: function dateOption(optionName, value) {\n    if (1 === arguments.length) {\n      return dateSerialization.deserializeDate(this.option(optionName));\n    }\n    var serializationFormat = this._getSerializationFormat();\n    this.option(optionName, dateSerialization.serializeDate(value, serializationFormat));\n  },\n  reset: function reset() {\n    this.callBase();\n    this._updateValue(this.dateOption(\"value\"));\n  }\n});\nregisterComponent(\"dxDateBox\", DateBox);\nmodule.exports = DateBox;","map":null,"metadata":{},"sourceType":"script"}