{"ast":null,"code":"/**\r\n * DevExtreme (core/dom_component_with_template.js)\r\n * Version: 19.2.2\r\n * Build date: Tue Oct 01 2019\r\n *\r\n * Copyright (c) 2012 - 2019 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\n\"use strict\";\n\nvar _renderer = require(\"./renderer\");\nvar _renderer2 = _interopRequireDefault(_renderer);\nvar _type = require(\"./utils/type\");\nvar _common = require(\"./utils/common\");\nvar _extend = require(\"./utils/extend\");\nvar _errors = require(\"./errors\");\nvar _dom = require(\"./utils/dom\");\nvar _devices = require(\"./devices\");\nvar _devices2 = _interopRequireDefault(_devices);\nvar _dom_component = require(\"./dom_component\");\nvar _dom_component2 = _interopRequireDefault(_dom_component);\nvar _template = require(\"./templates/template\");\nvar _template_base = require(\"./templates/template_base\");\nvar _function_template = require(\"./templates/function_template\");\nvar _empty_template = require(\"./templates/empty_template\");\nvar _child_default_template = require(\"./templates/child_default_template\");\nvar _inflector = require(\"./utils/inflector\");\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    \"default\": obj\n  };\n}\nvar TEXT_NODE = 3;\nvar ANONYMOUS_TEMPLATE_NAME = \"template\";\nvar TEMPLATE_SELECTOR = \"[data-options*='dxTemplate']\";\nvar TEMPLATE_WRAPPER_CLASS = \"dx-template-wrapper\";\nvar DX_POLYMORPH_WIDGET_TEMPLATE = new _function_template.FunctionTemplate(function (options) {\n  var widgetName = options.model.widget;\n  if (widgetName) {\n    var widgetElement = (0, _renderer2.default)(\"<div>\"),\n      widgetOptions = options.model.options || {};\n    if (\"button\" === widgetName || \"tabs\" === widgetName || \"dropDownMenu\" === widgetName) {\n      var deprecatedName = widgetName;\n      widgetName = (0, _inflector.camelize)(\"dx-\" + widgetName);\n      (0, _errors.log)(\"W0001\", \"dxToolbar - 'widget' item field\", deprecatedName, \"16.1\", \"Use: '\" + widgetName + \"' instead\");\n    }\n    if (options.parent) {\n      options.parent._createComponent(widgetElement, widgetName, widgetOptions);\n    } else {\n      widgetElement[widgetName](widgetOptions);\n    }\n    return widgetElement;\n  }\n  return (0, _renderer2.default)();\n});\nvar DOMComponentWithTemplate = _dom_component2.default.inherit({\n  _getDefaultOptions: function _getDefaultOptions() {\n    return (0, _extend.extend)(this.callBase(), {\n      integrationOptions: {\n        watchMethod: function watchMethod(fn, callback, options) {\n          options = options || {};\n          if (!options.skipImmediate) {\n            callback(fn());\n          }\n          return _common.noop;\n        },\n        templates: {\n          \"dx-polymorph-widget\": DX_POLYMORPH_WIDGET_TEMPLATE\n        },\n        createTemplate: function createTemplate(element) {\n          return new _template.Template(element);\n        }\n      }\n    });\n  },\n  _init: function _init() {\n    this.callBase();\n    this._tempTemplates = [];\n    this._defaultTemplates = {};\n    this._initTemplates();\n  },\n  _dispose: function _dispose() {\n    this._cleanTemplates();\n    this.callBase();\n  },\n  _cleanTemplates: function _cleanTemplates() {\n    this._tempTemplates.forEach(function (t) {\n      t.template.dispose && t.template.dispose();\n    });\n    this._tempTemplates = [];\n  },\n  _initTemplates: function _initTemplates() {\n    this._extractTemplates();\n    this._extractAnonymousTemplate();\n  },\n  _extractTemplates: function _extractTemplates() {\n    var templateElements = this.$element().contents().filter(TEMPLATE_SELECTOR);\n    var templatesMap = {};\n    templateElements.each(function (_, template) {\n      var templateOptions = (0, _dom.getElementOptions)(template).dxTemplate;\n      if (!templateOptions) {\n        return;\n      }\n      if (!templateOptions.name) {\n        throw (0, _errors.Error)(\"E0023\");\n      }\n      (0, _renderer2.default)(template).addClass(TEMPLATE_WRAPPER_CLASS).detach();\n      templatesMap[templateOptions.name] = templatesMap[templateOptions.name] || [];\n      templatesMap[templateOptions.name].push(template);\n    });\n    for (var templateName in templatesMap) {\n      var deviceTemplate = this._findTemplateByDevice(templatesMap[templateName]);\n      if (deviceTemplate) {\n        this._saveTemplate(templateName, deviceTemplate);\n      }\n    }\n  },\n  _saveTemplate: function _saveTemplate(name, template) {\n    var templates = this.option(\"integrationOptions.templates\");\n    templates[name] = this._createTemplate(template);\n  },\n  _findTemplateByDevice: function _findTemplateByDevice(templates) {\n    var suitableTemplate = (0, _common.findBestMatches)(_devices2.default.current(), templates, function (template) {\n      return (0, _dom.getElementOptions)(template).dxTemplate;\n    })[0];\n    templates.forEach(function (template) {\n      if (template !== suitableTemplate) {\n        (0, _renderer2.default)(template).remove();\n      }\n    });\n    return suitableTemplate;\n  },\n  _extractAnonymousTemplate: function _extractAnonymousTemplate() {\n    var templates = this.option(\"integrationOptions.templates\"),\n      anonymousTemplateName = this._getAnonymousTemplateName(),\n      $anonymousTemplate = this.$element().contents().detach();\n    var $notJunkTemplateContent = $anonymousTemplate.filter(function (_, element) {\n        var isTextNode = element.nodeType === TEXT_NODE,\n          isEmptyText = (0, _renderer2.default)(element).text().trim().length < 1;\n        return !(isTextNode && isEmptyText);\n      }),\n      onlyJunkTemplateContent = $notJunkTemplateContent.length < 1;\n    if (!templates[anonymousTemplateName] && !onlyJunkTemplateContent) {\n      templates[anonymousTemplateName] = this._createTemplate($anonymousTemplate);\n    }\n  },\n  _getAnonymousTemplateName: function _getAnonymousTemplateName() {\n    return ANONYMOUS_TEMPLATE_NAME;\n  },\n  _createTemplateIfNeeded: function _createTemplateIfNeeded(templateSource) {\n    var templateKey = function templateKey(templateSource) {\n      return (0, _type.isRenderer)(templateSource) && templateSource[0] || templateSource;\n    };\n    var cachedTemplate = this._tempTemplates.filter(function (t) {\n      templateSource = templateKey(templateSource);\n      return t.source === templateSource;\n    })[0];\n    if (cachedTemplate) {\n      return cachedTemplate.template;\n    }\n    var template = this._createTemplate(templateSource);\n    this._tempTemplates.push({\n      template: template,\n      source: templateKey(templateSource)\n    });\n    return template;\n  },\n  _createTemplate: function _createTemplate(templateSource) {\n    templateSource = \"string\" === typeof templateSource ? (0, _dom.normalizeTemplateElement)(templateSource) : templateSource;\n    return this.option(\"integrationOptions.createTemplate\")(templateSource);\n  },\n  _getTemplateByOption: function _getTemplateByOption(optionName) {\n    return this._getTemplate(this.option(optionName));\n  },\n  _getTemplate: function _getTemplate(templateSource) {\n    if ((0, _type.isFunction)(templateSource)) {\n      return new _function_template.FunctionTemplate(function (options) {\n        var templateSourceResult = templateSource.apply(this, this._getNormalizedTemplateArgs(options));\n        if (!(0, _type.isDefined)(templateSourceResult)) {\n          return new _empty_template.EmptyTemplate();\n        }\n        var dispose = false;\n        var template = this._acquireTemplate(templateSourceResult, function (templateSource) {\n          if (templateSource.nodeType || (0, _type.isRenderer)(templateSource) && !(0, _renderer2.default)(templateSource).is(\"script\")) {\n            return new _function_template.FunctionTemplate(function () {\n              return templateSource;\n            });\n          }\n          dispose = true;\n          return this._createTemplate(templateSource);\n        }.bind(this));\n        var result = template.render(options);\n        dispose && template.dispose && template.dispose();\n        return result;\n      }.bind(this));\n    }\n    return this._acquireTemplate(templateSource, this._createTemplateIfNeeded.bind(this));\n  },\n  _acquireTemplate: function _acquireTemplate(templateSource, createTemplate) {\n    if (null == templateSource) {\n      return new _empty_template.EmptyTemplate();\n    }\n    if (templateSource instanceof _child_default_template.ChildDefaultTemplate) {\n      return this._defaultTemplates[templateSource.name];\n    }\n    if (templateSource instanceof _template_base.TemplateBase) {\n      return templateSource;\n    }\n    if ((0, _type.isFunction)(templateSource.render) && !(0, _type.isRenderer)(templateSource)) {\n      return this._addOneRenderedCall(templateSource);\n    }\n    if (templateSource.nodeType || (0, _type.isRenderer)(templateSource)) {\n      return createTemplate((0, _renderer2.default)(templateSource));\n    }\n    if (\"string\" === typeof templateSource) {\n      return this._renderIntegrationTemplate(templateSource) || this._defaultTemplates[templateSource] || createTemplate(templateSource);\n    }\n    return this._acquireTemplate(templateSource.toString(), createTemplate);\n  },\n  _getNormalizedTemplateArgs: function _getNormalizedTemplateArgs(options) {\n    var args = [];\n    if (\"model\" in options) {\n      args.push(options.model);\n    }\n    if (\"index\" in options) {\n      args.push(options.index);\n    }\n    args.push(options.container);\n    return args;\n  },\n  _addOneRenderedCall: function _addOneRenderedCall(template) {\n    var _render = template.render.bind(template);\n    return (0, _extend.extend)({}, template, {\n      render: function render(options) {\n        var templateResult = _render(options);\n        options && options.onRendered && options.onRendered();\n        return templateResult;\n      }\n    });\n  },\n  _renderIntegrationTemplate: function _renderIntegrationTemplate(templateSource) {\n    var integrationTemplate = this.option(\"integrationOptions.templates\")[templateSource];\n    if (integrationTemplate && !(integrationTemplate instanceof _template_base.TemplateBase)) {\n      var isAsyncTemplate = this.option(\"templatesRenderAsynchronously\");\n      if (!isAsyncTemplate) {\n        return this._addOneRenderedCall(integrationTemplate);\n      }\n    }\n    return integrationTemplate;\n  }\n});\nmodule.exports = DOMComponentWithTemplate;","map":null,"metadata":{},"sourceType":"script"}