{"ast":null,"code":"/**\r\n * DevExtreme (ui/scroll_view/ui.scroll_view.native.pull_down.js)\r\n * Version: 19.2.2\r\n * Build date: Tue Oct 01 2019\r\n *\r\n * Copyright (c) 2012 - 2019 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\n\"use strict\";\n\nvar $ = require(\"../../core/renderer\"),\n  Callbacks = require(\"../../core/utils/callbacks\"),\n  translator = require(\"../../animation/translator\"),\n  NativeStrategy = require(\"./ui.scrollable.native\"),\n  LoadIndicator = require(\"../load_indicator\"),\n  each = require(\"../../core/utils/iterator\").each,\n  browser = require(\"../../core/utils/browser\"),\n  Deferred = require(\"../../core/utils/deferred\").Deferred;\nvar SCROLLVIEW_PULLDOWN_REFRESHING_CLASS = \"dx-scrollview-pull-down-loading\",\n  SCROLLVIEW_PULLDOWN_READY_CLASS = \"dx-scrollview-pull-down-ready\",\n  SCROLLVIEW_PULLDOWN_IMAGE_CLASS = \"dx-scrollview-pull-down-image\",\n  SCROLLVIEW_PULLDOWN_INDICATOR_CLASS = \"dx-scrollview-pull-down-indicator\",\n  SCROLLVIEW_PULLDOWN_TEXT_CLASS = \"dx-scrollview-pull-down-text\",\n  SCROLLVIEW_PULLDOWN_VISIBLE_TEXT_CLASS = \"dx-scrollview-pull-down-text-visible\",\n  STATE_RELEASED = 0,\n  STATE_READY = 1,\n  STATE_REFRESHING = 2,\n  STATE_LOADING = 3,\n  PULLDOWN_RELEASE_TIME = 400;\nvar PullDownNativeScrollViewStrategy = NativeStrategy.inherit({\n  _init: function _init(scrollView) {\n    this.callBase(scrollView);\n    this._$topPocket = scrollView._$topPocket;\n    this._$pullDown = scrollView._$pullDown;\n    this._$bottomPocket = scrollView._$bottomPocket;\n    this._$refreshingText = scrollView._$refreshingText;\n    this._$scrollViewContent = $(scrollView.content());\n    this._initCallbacks();\n  },\n  _initCallbacks: function _initCallbacks() {\n    this.pullDownCallbacks = Callbacks();\n    this.releaseCallbacks = Callbacks();\n    this.reachBottomCallbacks = Callbacks();\n  },\n  render: function render() {\n    this.callBase();\n    this._renderPullDown();\n    this._releaseState();\n  },\n  _renderPullDown: function _renderPullDown() {\n    var $image = $(\"<div>\").addClass(SCROLLVIEW_PULLDOWN_IMAGE_CLASS),\n      $loadContainer = $(\"<div>\").addClass(SCROLLVIEW_PULLDOWN_INDICATOR_CLASS),\n      $loadIndicator = new LoadIndicator($(\"<div>\")).$element(),\n      $text = this._$pullDownText = $(\"<div>\").addClass(SCROLLVIEW_PULLDOWN_TEXT_CLASS);\n    this._$pullingDownText = $(\"<div>\").text(this.option(\"pullingDownText\")).appendTo($text);\n    this._$pulledDownText = $(\"<div>\").text(this.option(\"pulledDownText\")).appendTo($text);\n    this._$refreshingText = $(\"<div>\").text(this.option(\"refreshingText\")).appendTo($text);\n    this._$pullDown.empty().append($image).append($loadContainer.append($loadIndicator)).append($text);\n  },\n  _releaseState: function _releaseState() {\n    this._state = STATE_RELEASED;\n    this._refreshPullDownText();\n  },\n  _pushBackFromBoundary: function _pushBackFromBoundary() {\n    if (!this._isLocked() && !this._component.isEmpty()) {\n      this.callBase();\n    }\n  },\n  _refreshPullDownText: function _refreshPullDownText() {\n    var that = this,\n      pullDownTextItems = [{\n        element: this._$pullingDownText,\n        visibleState: STATE_RELEASED\n      }, {\n        element: this._$pulledDownText,\n        visibleState: STATE_READY\n      }, {\n        element: this._$refreshingText,\n        visibleState: STATE_REFRESHING\n      }];\n    each(pullDownTextItems, function (_, item) {\n      var action = that._state === item.visibleState ? \"addClass\" : \"removeClass\";\n      item.element[action](SCROLLVIEW_PULLDOWN_VISIBLE_TEXT_CLASS);\n    });\n  },\n  update: function update() {\n    this.callBase();\n    this._setTopPocketOffset();\n  },\n  _updateDimensions: function _updateDimensions() {\n    this.callBase();\n    this._topPocketSize = this._$topPocket.height();\n    this._bottomPocketSize = this._$bottomPocket.height();\n    if (browser.msie) {\n      this._scrollOffset = Math.round(100 * (this._$container.height() - this._$content.height())) / 100;\n    } else {\n      this._scrollOffset = this._$container.height() - this._$content.height();\n    }\n  },\n  _allowedDirections: function _allowedDirections() {\n    var allowedDirections = this.callBase();\n    allowedDirections.vertical = allowedDirections.vertical || this._pullDownEnabled;\n    return allowedDirections;\n  },\n  _setTopPocketOffset: function _setTopPocketOffset() {\n    this._$topPocket.css({\n      top: -this._topPocketSize\n    });\n  },\n  handleEnd: function handleEnd() {\n    this.callBase();\n    this._complete();\n  },\n  handleStop: function handleStop() {\n    this.callBase();\n    this._complete();\n  },\n  _complete: function _complete() {\n    if (this._state === STATE_READY) {\n      this._setPullDownOffset(this._topPocketSize);\n      clearTimeout(this._pullDownRefreshTimeout);\n      this._pullDownRefreshTimeout = setTimeout(function () {\n        this._pullDownRefreshing();\n      }.bind(this), 400);\n    }\n  },\n  _setPullDownOffset: function _setPullDownOffset(offset) {\n    translator.move(this._$topPocket, {\n      top: offset\n    });\n    translator.move(this._$scrollViewContent, {\n      top: offset\n    });\n  },\n  handleScroll: function handleScroll(e) {\n    this.callBase(e);\n    if (this._state === STATE_REFRESHING) {\n      return;\n    }\n    var currentLocation = this.location().top,\n      scrollDelta = (this._location || 0) - currentLocation;\n    this._location = currentLocation;\n    if (this._isPullDown()) {\n      this._pullDownReady();\n    } else {\n      if (scrollDelta > 0 && this._isReachBottom()) {\n        this._reachBottom();\n      } else {\n        this._stateReleased();\n      }\n    }\n  },\n  _isPullDown: function _isPullDown() {\n    return this._pullDownEnabled && this._location >= this._topPocketSize;\n  },\n  _isReachBottom: function _isReachBottom() {\n    if (browser.msie) {\n      return this._reachBottomEnabled && this._location - (this._scrollOffset + this._bottomPocketSize) <= .1;\n    } else {\n      return this._reachBottomEnabled && this._location <= this._scrollOffset + this._bottomPocketSize;\n    }\n  },\n  _reachBottom: function _reachBottom() {\n    if (this._state === STATE_LOADING) {\n      return;\n    }\n    this._state = STATE_LOADING;\n    this.reachBottomCallbacks.fire();\n  },\n  _pullDownReady: function _pullDownReady() {\n    if (this._state === STATE_READY) {\n      return;\n    }\n    this._state = STATE_READY;\n    this._$pullDown.addClass(SCROLLVIEW_PULLDOWN_READY_CLASS);\n    this._refreshPullDownText();\n  },\n  _stateReleased: function _stateReleased() {\n    if (this._state === STATE_RELEASED) {\n      return;\n    }\n    this._$pullDown.removeClass(SCROLLVIEW_PULLDOWN_REFRESHING_CLASS).removeClass(SCROLLVIEW_PULLDOWN_READY_CLASS);\n    this._releaseState();\n  },\n  _pullDownRefreshing: function _pullDownRefreshing() {\n    if (this._state === STATE_REFRESHING) {\n      return;\n    }\n    this._state = STATE_REFRESHING;\n    this._$pullDown.addClass(SCROLLVIEW_PULLDOWN_REFRESHING_CLASS).removeClass(SCROLLVIEW_PULLDOWN_READY_CLASS);\n    this._refreshPullDownText();\n    this.pullDownCallbacks.fire();\n  },\n  pullDownEnable: function pullDownEnable(enabled) {\n    if (enabled) {\n      this._updateDimensions();\n      this._setTopPocketOffset();\n    }\n    this._pullDownEnabled = enabled;\n  },\n  reachBottomEnable: function reachBottomEnable(enabled) {\n    this._reachBottomEnabled = enabled;\n  },\n  pendingRelease: function pendingRelease() {\n    this._state = STATE_READY;\n  },\n  release: function release() {\n    var deferred = new Deferred();\n    this._updateDimensions();\n    clearTimeout(this._releaseTimeout);\n    if (this._state === STATE_LOADING) {\n      this._state = STATE_RELEASED;\n    }\n    this._releaseTimeout = setTimeout(function () {\n      this._setPullDownOffset(0);\n      this._stateReleased();\n      this.releaseCallbacks.fire();\n      this._updateAction();\n      deferred.resolve();\n    }.bind(this), PULLDOWN_RELEASE_TIME);\n    return deferred.promise();\n  },\n  dispose: function dispose() {\n    clearTimeout(this._pullDownRefreshTimeout);\n    clearTimeout(this._releaseTimeout);\n    this.callBase();\n  }\n});\nmodule.exports = PullDownNativeScrollViewStrategy;","map":null,"metadata":{},"sourceType":"script"}