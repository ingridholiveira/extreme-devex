{"ast":null,"code":"/**\r\n * DevExtreme (ui/grid_core/ui.grid_core.virtual_scrolling.js)\r\n * Version: 19.2.2\r\n * Build date: Tue Oct 01 2019\r\n *\r\n * Copyright (c) 2012 - 2019 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\n\"use strict\";\n\nvar _renderer = require(\"../../core/renderer\");\nvar _renderer2 = _interopRequireDefault(_renderer);\nvar _window = require(\"../../core/utils/window\");\nvar _common = require(\"../../core/utils/common\");\nvar _uiGrid_core = require(\"./ui.grid_core.virtual_scrolling_core\");\nvar _uiGrid_core2 = _interopRequireDefault(_uiGrid_core);\nvar _uiGrid_core3 = require(\"./ui.grid_core.utils\");\nvar _uiGrid_core4 = _interopRequireDefault(_uiGrid_core3);\nvar _iterator = require(\"../../core/utils/iterator\");\nvar _deferred = require(\"../../core/utils/deferred\");\nvar _translator = require(\"../../animation/translator\");\nvar _translator2 = _interopRequireDefault(_translator);\nvar _load_indicator = require(\"../load_indicator\");\nvar _load_indicator2 = _interopRequireDefault(_load_indicator);\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    \"default\": obj\n  };\n}\nvar TABLE_CLASS = \"table\",\n  BOTTOM_LOAD_PANEL_CLASS = \"bottom-load-panel\",\n  TABLE_CONTENT_CLASS = \"table-content\",\n  GROUP_SPACE_CLASS = \"group-space\",\n  CONTENT_CLASS = \"content\",\n  ROW_CLASS = \"dx-row\",\n  FREESPACE_CLASS = \"dx-freespace-row\",\n  COLUMN_LINES_CLASS = \"dx-column-lines\",\n  VIRTUAL_ROW_CLASS = \"dx-virtual-row\",\n  SCROLLING_MODE_INFINITE = \"infinite\",\n  SCROLLING_MODE_VIRTUAL = \"virtual\",\n  SCROLLING_MODE_STANDARD = \"standard\",\n  PIXELS_LIMIT = 25e4;\nvar isVirtualMode = function isVirtualMode(that) {\n  return that.option(\"scrolling.mode\") === SCROLLING_MODE_VIRTUAL;\n};\nvar isAppendMode = function isAppendMode(that) {\n  return that.option(\"scrolling.mode\") === SCROLLING_MODE_INFINITE;\n};\nvar isVirtualRowRendering = function isVirtualRowRendering(that) {\n  var rowRenderingMode = that.option(\"scrolling.rowRenderingMode\");\n  if (rowRenderingMode === SCROLLING_MODE_VIRTUAL) {\n    return true;\n  } else {\n    if (rowRenderingMode === SCROLLING_MODE_STANDARD) {\n      return false;\n    }\n  }\n};\nvar _correctCount = function _correctCount(items, count, fromEnd, isItemCountableFunc) {\n  var countCorrection = fromEnd ? 0 : 1;\n  for (var i = 0; i < count + countCorrection; i++) {\n    var item = items[fromEnd ? items.length - 1 - i : i];\n    if (item && !isItemCountableFunc(item, i === count)) {\n      count++;\n    }\n  }\n  return count;\n};\nvar VirtualScrollingDataSourceAdapterExtender = function () {\n  var _updateLoading = function _updateLoading(that) {\n    var beginPageIndex = that._virtualScrollController.beginPageIndex(-1);\n    if (isVirtualMode(that)) {\n      if (beginPageIndex < 0 || that.viewportSize() >= 0 && that.getViewportItemIndex() >= 0 && (beginPageIndex * that.pageSize() > that.getViewportItemIndex() || beginPageIndex * that.pageSize() + that.itemsCount() < that.getViewportItemIndex() + that.viewportSize()) && that._dataSource.isLoading()) {\n        if (!that._isLoading) {\n          that._isLoading = true;\n          that.loadingChanged.fire(true);\n        }\n      } else {\n        if (that._isLoading) {\n          that._isLoading = false;\n          that.loadingChanged.fire(false);\n        }\n      }\n    }\n  };\n  var result = {\n    init: function init(dataSource) {\n      var that = this;\n      that.callBase.apply(that, arguments);\n      that._items = [];\n      that._isLoaded = true;\n      that._virtualScrollController = new _uiGrid_core2.default.VirtualScrollController(that.component, {\n        pageSize: function pageSize() {\n          return that.pageSize();\n        },\n        totalItemsCount: function totalItemsCount() {\n          return that.totalItemsCount();\n        },\n        hasKnownLastPage: function hasKnownLastPage() {\n          return that.hasKnownLastPage();\n        },\n        pageIndex: function pageIndex(index) {\n          return dataSource.pageIndex(index);\n        },\n        isLoading: function isLoading() {\n          return dataSource.isLoading() && !that.isCustomLoading();\n        },\n        pageCount: function pageCount() {\n          return that.pageCount();\n        },\n        load: function load() {\n          return dataSource.load();\n        },\n        updateLoading: function updateLoading() {\n          _updateLoading(that);\n        },\n        itemsCount: function itemsCount() {\n          return that.itemsCount(true);\n        },\n        items: function items() {\n          return dataSource.items();\n        },\n        viewportItems: function viewportItems(items) {\n          if (items) {\n            that._items = items;\n          }\n          return that._items;\n        },\n        onChanged: function onChanged(e) {\n          that.changed.fire(e);\n        },\n        changingDuration: function changingDuration(e) {\n          return that._renderTime || 0;\n        }\n      });\n    },\n    _handleLoadingChanged: function _handleLoadingChanged(isLoading) {\n      var that = this;\n      if (!isVirtualMode(that)) {\n        that._isLoading = isLoading;\n        that.callBase.apply(that, arguments);\n      }\n    },\n    _handleLoadError: function _handleLoadError() {\n      var that = this;\n      that._isLoading = false;\n      that.loadingChanged.fire(false);\n      that.callBase.apply(that, arguments);\n    },\n    _handleDataChanged: function _handleDataChanged(e) {\n      var callBase = this.callBase.bind(this);\n      this._virtualScrollController.handleDataChanged(callBase, e);\n    },\n    _customizeRemoteOperations: function _customizeRemoteOperations(options, isReload, operationTypes) {\n      var that = this;\n      if (!that.option(\"legacyRendering\") && isVirtualMode(that) && !(operationTypes.reload || isReload) && operationTypes.skip && that._renderTime < that.option(\"scrolling.renderingThreshold\")) {\n        options.delay = void 0;\n      }\n      that.callBase.apply(that, arguments);\n    },\n    items: function items() {\n      return this._items;\n    },\n    itemsCount: function itemsCount(isBase) {\n      if (isBase) {\n        return this.callBase();\n      }\n      return this._virtualScrollController.itemsCount();\n    },\n    load: function load(loadOptions) {\n      if (loadOptions) {\n        return this.callBase(loadOptions);\n      }\n      return this._virtualScrollController.load();\n    },\n    isLoading: function isLoading() {\n      return this._isLoading;\n    },\n    isLoaded: function isLoaded() {\n      return this._dataSource.isLoaded() && this._isLoaded;\n    },\n    resetPagesCache: function resetPagesCache(isLiveUpdate) {\n      if (!isLiveUpdate) {\n        this._virtualScrollController.reset();\n      }\n      this.callBase.apply(this, arguments);\n    },\n    _changeRowExpandCore: function _changeRowExpandCore() {\n      var result = this.callBase.apply(this, arguments);\n      this.resetPagesCache();\n      _updateLoading(this);\n      return result;\n    },\n    reload: function reload() {\n      this._dataSource.pageIndex(this.pageIndex());\n      var virtualScrollController = this._virtualScrollController;\n      if (virtualScrollController) {\n        var d = new _deferred.Deferred();\n        this.callBase.apply(this, arguments).done(function (r) {\n          var delayDeferred = virtualScrollController._delayDeferred;\n          if (delayDeferred) {\n            delayDeferred.done(d.resolve).fail(d.reject);\n          } else {\n            d.resolve(r);\n          }\n        }).fail(d.reject);\n        return d;\n      } else {\n        return this.callBase.apply(this, arguments);\n      }\n    },\n    refresh: function refresh(options, isReload, operationTypes) {\n      var that = this,\n        storeLoadOptions = options.storeLoadOptions,\n        dataSource = that._dataSource;\n      if (isReload || operationTypes.reload) {\n        that._virtualScrollController.reset();\n        dataSource.items().length = 0;\n        that._isLoaded = false;\n        _updateLoading(that);\n        that._isLoaded = true;\n        if (isAppendMode(that)) {\n          that.pageIndex(0);\n          dataSource.pageIndex(0);\n          storeLoadOptions.pageIndex = 0;\n          options.pageIndex = 0;\n          storeLoadOptions.skip = 0;\n        } else {\n          dataSource.pageIndex(that.pageIndex());\n          if (dataSource.paginate()) {\n            options.pageIndex = that.pageIndex();\n            storeLoadOptions.skip = that.pageIndex() * that.pageSize();\n          }\n        }\n      }\n      return that.callBase.apply(that, arguments);\n    },\n    dispose: function dispose() {\n      this._virtualScrollController.dispose();\n      this.callBase.apply(this, arguments);\n    }\n  };\n  [\"virtualItemsCount\", \"getContentOffset\", \"getVirtualContentSize\", \"setContentSize\", \"setViewportPosition\", \"getViewportItemIndex\", \"setViewportItemIndex\", \"getItemIndexByPosition\", \"viewportSize\", \"viewportItemSize\", \"getItemSize\", \"getItemSizes\", \"pageIndex\", \"beginPageIndex\", \"endPageIndex\", \"loadIfNeed\"].forEach(function (name) {\n    result[name] = function () {\n      var virtualScrollController = this._virtualScrollController;\n      return virtualScrollController[name].apply(virtualScrollController, arguments);\n    };\n  });\n  return result;\n}();\nvar VirtualScrollingRowsViewExtender = function () {\n  var removeEmptyRows = function removeEmptyRows($emptyRows, className) {\n    var rowCount,\n      $tBodies = $emptyRows.parent(\".\" + className);\n    if ($tBodies.length) {\n      $emptyRows = $tBodies;\n    }\n    rowCount = className === FREESPACE_CLASS ? $emptyRows.length - 1 : $emptyRows.length;\n    for (var i = 0; i < rowCount; i++) {\n      $emptyRows.eq(i).remove();\n    }\n  };\n  return {\n    init: function init() {\n      var that = this,\n        dataController = that.getController(\"data\");\n      that.callBase();\n      dataController.pageChanged.add(function () {\n        that.scrollToPage(dataController.pageIndex());\n      });\n      if (!that.option(\"legacyRendering\") && dataController.pageIndex() > 0) {\n        var resizeHandler = function resizeHandler() {\n          that.resizeCompleted.remove(resizeHandler);\n          that.scrollToPage(dataController.pageIndex());\n        };\n        that.resizeCompleted.add(resizeHandler);\n      }\n    },\n    scrollToPage: function scrollToPage(pageIndex) {\n      var scrollPosition,\n        that = this,\n        dataController = that._dataController,\n        pageSize = dataController ? dataController.pageSize() : 0;\n      if (isVirtualMode(that) || isAppendMode(that)) {\n        var itemSize = dataController.getItemSize(),\n          itemSizes = dataController.getItemSizes(),\n          itemIndex = pageIndex * pageSize;\n        scrollPosition = itemIndex * itemSize;\n        for (var index in itemSizes) {\n          if (index <= itemIndex) {\n            scrollPosition += itemSizes[index] - itemSize;\n          }\n        }\n      } else {\n        scrollPosition = 0;\n      }\n      that.scrollTo({\n        y: scrollPosition,\n        x: that._scrollLeft\n      });\n    },\n    renderDelayedTemplates: function renderDelayedTemplates(e) {\n      this._updateContentPosition(true);\n      this.callBase.apply(this, arguments);\n    },\n    _renderCore: function _renderCore(e) {\n      var that = this,\n        startRenderDate = new Date();\n      that.callBase.apply(that, arguments);\n      var dataSource = that._dataController._dataSource;\n      if (dataSource && e) {\n        var itemCount = e.items ? e.items.length : 20;\n        var viewportSize = that._dataController.viewportSize() || 20;\n        if (isVirtualRowRendering(that)) {\n          dataSource._renderTime = (new Date() - startRenderDate) * viewportSize / itemCount;\n        } else {\n          dataSource._renderTime = new Date() - startRenderDate;\n        }\n      }\n    },\n    _getRowElements: function _getRowElements(tableElement) {\n      var $rows = this.callBase(tableElement);\n      return $rows && $rows.not(\".\" + VIRTUAL_ROW_CLASS);\n    },\n    _renderContent: function _renderContent(contentElement, tableElement) {\n      var that = this,\n        virtualItemsCount = that._dataController.virtualItemsCount();\n      if (virtualItemsCount && that.option(\"legacyRendering\")) {\n        if ((0, _window.hasWindow)()) {\n          tableElement.addClass(that.addWidgetPrefix(TABLE_CONTENT_CLASS));\n        }\n        if (!contentElement.children().length) {\n          contentElement.append(tableElement);\n        } else {\n          contentElement.children().first().replaceWith(tableElement);\n        }\n        if (1 === contentElement.children(\"table\").length) {\n          contentElement.append(that._createTable());\n          that._contentHeight = 0;\n        }\n        return contentElement;\n      }\n      return that.callBase.apply(that, arguments);\n    },\n    _removeRowsElements: function _removeRowsElements(contentTable, removeCount, changeType) {\n      var rowElements = this._getRowElements(contentTable).toArray();\n      if (\"append\" === changeType) {\n        rowElements = rowElements.slice(0, removeCount);\n      } else {\n        rowElements = rowElements.slice(-removeCount);\n      }\n      var errorHandlingController = this.getController(\"errorHandling\");\n      rowElements.map(function (rowElement) {\n        var $rowElement = (0, _renderer2.default)(rowElement);\n        errorHandlingController && errorHandlingController.removeErrorRow($rowElement.next());\n        $rowElement.remove();\n      });\n    },\n    _restoreErrorRow: function _restoreErrorRow(contentTable) {\n      var editingController = this.getController(\"editing\");\n      editingController && editingController.hasChanges() && this._getRowElements(contentTable).each(function (_, item) {\n        var rowOptions = (0, _renderer2.default)(item).data(\"options\");\n        if (rowOptions) {\n          var editData = editingController.getEditDataByKey(rowOptions.key);\n          editData && editingController._showErrorRow(editData);\n        }\n      });\n    },\n    _updateContent: function _updateContent(tableElement, change) {\n      var contentTable,\n        $freeSpaceRowElements,\n        that = this,\n        contentElement = that._findContentElement(),\n        changeType = change && change.changeType;\n      if (\"append\" === changeType || \"prepend\" === changeType) {\n        contentTable = contentElement.children().first();\n        var $tBodies = that._getBodies(tableElement);\n        if (!that.option(\"legacyRendering\") && 1 === $tBodies.length) {\n          that._getBodies(contentTable)[\"append\" === changeType ? \"append\" : \"prepend\"]($tBodies.children());\n        } else {\n          $tBodies[\"append\" === changeType ? \"appendTo\" : \"prependTo\"](contentTable);\n        }\n        tableElement.remove();\n        $freeSpaceRowElements = that._getFreeSpaceRowElements(contentTable);\n        removeEmptyRows($freeSpaceRowElements, FREESPACE_CLASS);\n        if (change.removeCount) {\n          that._removeRowsElements(contentTable, change.removeCount, changeType);\n        }\n        that._restoreErrorRow(contentTable);\n      } else {\n        that.callBase.apply(that, arguments);\n      }\n      that._updateBottomLoading();\n    },\n    _addVirtualRow: function _addVirtualRow($table, isFixed, location, position) {\n      if (!position) {\n        return;\n      }\n      var $virtualRow = this._createEmptyRow(VIRTUAL_ROW_CLASS, isFixed, position);\n      $virtualRow = this._wrapRowIfNeed($table, $virtualRow);\n      this._appendEmptyRow($table, $virtualRow, location);\n    },\n    _updateContentPosition: function _updateContentPosition(isRender) {\n      var that = this,\n        dataController = that._dataController,\n        rowHeight = that._rowHeight || 20;\n      dataController.viewportItemSize(rowHeight);\n      if (!that.option(\"legacyRendering\") && (isVirtualMode(that) || isVirtualRowRendering(that))) {\n        if (!isRender) {\n          var rowHeights = that._getRowElements(that._tableElement).toArray().map(function (row) {\n            return row.getBoundingClientRect().height;\n          });\n          dataController.setContentSize(rowHeights);\n        }\n        var top = dataController.getContentOffset(\"begin\"),\n          bottom = dataController.getContentOffset(\"end\"),\n          $tables = that.getTableElements(),\n          $virtualRows = $tables.children(\"tbody\").children(\".\" + VIRTUAL_ROW_CLASS);\n        removeEmptyRows($virtualRows, VIRTUAL_ROW_CLASS);\n        $tables.each(function (index) {\n          var isFixed = index > 0;\n          that._isFixedTableRendering = isFixed;\n          that._addVirtualRow((0, _renderer2.default)(this), isFixed, \"top\", top);\n          that._addVirtualRow((0, _renderer2.default)(this), isFixed, \"bottom\", bottom);\n          that._isFixedTableRendering = false;\n        });\n        !isRender && that._updateScrollTopPosition(top);\n      } else {\n        (0, _common.deferUpdate)(function () {\n          that._updateContentPositionCore();\n        });\n      }\n    },\n    _updateScrollTopPosition: function _updateScrollTopPosition(top) {\n      if (this._scrollTop < top && !this._isScrollByEvent && this._dataController.pageIndex() > 0) {\n        this.scrollTo({\n          top: top,\n          left: this._scrollLeft\n        });\n      }\n    },\n    _updateContentPositionCore: function _updateContentPositionCore() {\n      var contentElement,\n        contentHeight,\n        top,\n        $tables,\n        $contentTable,\n        virtualTable,\n        isRenderVirtualTableContentRequired,\n        that = this,\n        rowHeight = that._rowHeight || 20,\n        virtualItemsCount = that._dataController.virtualItemsCount();\n      if (virtualItemsCount) {\n        contentElement = that._findContentElement();\n        $tables = contentElement.children();\n        $contentTable = $tables.eq(0);\n        virtualTable = $tables.eq(1);\n        that._contentTableHeight = $contentTable[0].offsetHeight;\n        that._dataController.viewportItemSize(rowHeight);\n        that._dataController.setContentSize(that._contentTableHeight);\n        contentHeight = that._dataController.getVirtualContentSize();\n        top = that._dataController.getContentOffset();\n        (0, _common.deferRender)(function () {\n          _translator2.default.move($contentTable, {\n            left: 0,\n            top: top\n          });\n          isRenderVirtualTableContentRequired = that._contentHeight !== contentHeight || 0 === contentHeight || !that._isTableLinesDisplaysCorrect(virtualTable) || !that._isColumnElementsEqual($contentTable.find(\"col\"), virtualTable.find(\"col\"));\n          if (isRenderVirtualTableContentRequired) {\n            that._contentHeight = contentHeight;\n            that._renderVirtualTableContent(virtualTable, contentHeight);\n          }\n          that._updateScrollTopPosition(top);\n        });\n      }\n    },\n    _isTableLinesDisplaysCorrect: function _isTableLinesDisplaysCorrect(table) {\n      var hasColumnLines = table.find(\".\" + COLUMN_LINES_CLASS).length > 0;\n      return hasColumnLines === this.option(\"showColumnLines\");\n    },\n    _isColumnElementsEqual: function _isColumnElementsEqual($columns, $virtualColumns) {\n      var result = $columns.length === $virtualColumns.length;\n      if (result) {\n        (0, _iterator.each)($columns, function (index, element) {\n          if (element.style.width !== $virtualColumns[index].style.width) {\n            result = false;\n            return result;\n          }\n        });\n      }\n      return result;\n    },\n    _renderVirtualTableContent: function _renderVirtualTableContent(container, height) {\n      var i,\n        that = this,\n        columns = that._columnsController.getVisibleColumns(),\n        html = that._createColGroup(columns).prop(\"outerHTML\"),\n        freeSpaceCellsHtml = \"\",\n        columnLinesClass = that.option(\"showColumnLines\") ? COLUMN_LINES_CLASS : \"\",\n        createFreeSpaceRowHtml = function createFreeSpaceRowHtml(height) {\n          return \"<tr style='height:\" + height + \"px;' class='\" + FREESPACE_CLASS + \" \" + ROW_CLASS + \" \" + columnLinesClass + \"' >\" + freeSpaceCellsHtml + \"</tr>\";\n        };\n      for (i = 0; i < columns.length; i++) {\n        var classes = that._getCellClasses(columns[i]),\n          classString = classes.length ? \" class='\" + classes.join(\" \") + \"'\" : \"\";\n        freeSpaceCellsHtml += \"<td\" + classString + \"/>\";\n      }\n      while (height > PIXELS_LIMIT) {\n        html += createFreeSpaceRowHtml(PIXELS_LIMIT);\n        height -= PIXELS_LIMIT;\n      }\n      html += createFreeSpaceRowHtml(height);\n      container.addClass(that.addWidgetPrefix(TABLE_CLASS));\n      container.html(html);\n    },\n    _getCellClasses: function _getCellClasses(column) {\n      var classes = [],\n        cssClass = column.cssClass,\n        isExpandColumn = \"expand\" === column.command;\n      cssClass && classes.push(cssClass);\n      isExpandColumn && classes.push(this.addWidgetPrefix(GROUP_SPACE_CLASS));\n      return classes;\n    },\n    _findBottomLoadPanel: function _findBottomLoadPanel($contentElement) {\n      var $element = $contentElement || this.element();\n      var $bottomLoadPanel = $element && $element.find(\".\" + this.addWidgetPrefix(BOTTOM_LOAD_PANEL_CLASS));\n      if ($bottomLoadPanel && $bottomLoadPanel.length) {\n        return $bottomLoadPanel;\n      }\n    },\n    _updateBottomLoading: function _updateBottomLoading() {\n      var that = this,\n        scrollingMode = that.option(\"scrolling.mode\"),\n        virtualMode = scrollingMode === SCROLLING_MODE_VIRTUAL,\n        appendMode = scrollingMode === SCROLLING_MODE_INFINITE,\n        showBottomLoading = !that._dataController.hasKnownLastPage() && that._dataController.isLoaded() && (virtualMode || appendMode),\n        $contentElement = that._findContentElement(),\n        bottomLoadPanelElement = that._findBottomLoadPanel($contentElement);\n      if (showBottomLoading) {\n        if (!bottomLoadPanelElement) {\n          (0, _renderer2.default)(\"<div>\").addClass(that.addWidgetPrefix(BOTTOM_LOAD_PANEL_CLASS)).append(that._createComponent((0, _renderer2.default)(\"<div>\"), _load_indicator2.default).$element()).appendTo($contentElement);\n        }\n      } else {\n        if (bottomLoadPanelElement) {\n          bottomLoadPanelElement.remove();\n        }\n      }\n    },\n    _handleScroll: function _handleScroll(e) {\n      var that = this;\n      if (that._hasHeight && that._rowHeight) {\n        that._dataController.setViewportPosition(e.scrollOffset.top);\n      }\n      that.callBase.apply(that, arguments);\n    },\n    _needUpdateRowHeight: function _needUpdateRowHeight(itemsCount) {\n      var that = this;\n      return that.callBase.apply(that, arguments) || itemsCount > 0 && that.option(\"scrolling.mode\") === SCROLLING_MODE_INFINITE && that.option(\"scrolling.rowRenderingMode\") !== SCROLLING_MODE_VIRTUAL;\n    },\n    _updateRowHeight: function _updateRowHeight() {\n      var viewportHeight,\n        that = this;\n      that.callBase.apply(that, arguments);\n      if (that._rowHeight) {\n        that._updateContentPosition();\n        viewportHeight = that._hasHeight ? that.element().outerHeight() : (0, _renderer2.default)((0, _window.getWindow)()).outerHeight();\n        that._dataController.viewportSize(Math.ceil(viewportHeight / that._rowHeight));\n      }\n    },\n    updateFreeSpaceRowHeight: function updateFreeSpaceRowHeight() {\n      var result = this.callBase.apply(this, arguments);\n      if (result) {\n        this._updateContentPosition();\n      }\n      return result;\n    },\n    setLoading: function setLoading(isLoading, messageText) {\n      var that = this,\n        callBase = that.callBase,\n        dataController = that._dataController,\n        hasBottomLoadPanel = dataController.pageIndex() > 0 && dataController.isLoaded() && !!that._findBottomLoadPanel();\n      if (hasBottomLoadPanel) {\n        isLoading = false;\n      }\n      callBase.call(that, isLoading, messageText);\n    },\n    _resizeCore: function _resizeCore() {\n      var that = this,\n        $element = that.element();\n      that.callBase();\n      if (that.component.$element() && !that._windowScroll && $element.closest((0, _window.getWindow)().document).length) {\n        that._windowScroll = _uiGrid_core2.default.subscribeToExternalScrollers($element, function (scrollPos) {\n          if (!that._hasHeight && that._rowHeight) {\n            that._dataController.setViewportPosition(scrollPos);\n          }\n        }, that.component.$element());\n        that.on(\"disposing\", function () {\n          that._windowScroll.dispose();\n        });\n      }\n      that.loadIfNeed();\n    },\n    loadIfNeed: function loadIfNeed() {\n      var dataController = this._dataController;\n      if (dataController && dataController.loadIfNeed) {\n        dataController.loadIfNeed();\n      }\n    },\n    setColumnWidths: function setColumnWidths(widths) {\n      var $content,\n        scrollable = this.getScrollable();\n      this.callBase.apply(this, arguments);\n      if (\"virtual\" === this.option(\"scrolling.mode\")) {\n        $content = scrollable ? scrollable.$content() : this.element();\n        this.callBase(widths, $content.children(\".\" + this.addWidgetPrefix(CONTENT_CLASS)).children(\":not(.\" + this.addWidgetPrefix(TABLE_CONTENT_CLASS) + \")\"));\n      }\n    },\n    dispose: function dispose() {\n      clearTimeout(this._scrollTimeoutID);\n      this.callBase();\n    }\n  };\n}();\nmodule.exports = {\n  defaultOptions: function defaultOptions() {\n    return {\n      scrolling: {\n        timeout: 300,\n        updateTimeout: 300,\n        minTimeout: 0,\n        renderingThreshold: 100,\n        removeInvisiblePages: true,\n        rowPageSize: 5,\n        mode: \"standard\",\n        preloadEnabled: false,\n        rowRenderingMode: \"standard\"\n      }\n    };\n  },\n  extenders: {\n    dataSourceAdapter: VirtualScrollingDataSourceAdapterExtender,\n    controllers: {\n      data: function () {\n        var members = {\n          _refreshDataSource: function _refreshDataSource() {\n            var baseResult = this.callBase.apply(this, arguments) || new _deferred.Deferred().resolve().promise();\n            baseResult.done(this.initVirtualRows.bind(this));\n            return baseResult;\n          },\n          getRowPageSize: function getRowPageSize() {\n            var rowPageSize = this.option(\"scrolling.rowPageSize\"),\n              pageSize = this.pageSize();\n            return pageSize && pageSize < rowPageSize ? pageSize : rowPageSize;\n          },\n          reload: function reload() {\n            var that = this,\n              rowsScrollController = that._rowsScrollController || that._dataSource,\n              itemIndex = rowsScrollController && rowsScrollController.getItemIndexByPosition(),\n              result = this.callBase.apply(this, arguments);\n            return result && result.done(function () {\n              if (isVirtualMode(that) || isVirtualRowRendering(that)) {\n                var rowIndexOffset = that.getRowIndexOffset(),\n                  rowIndex = Math.floor(itemIndex) - rowIndexOffset,\n                  component = that.component,\n                  scrollable = component.getScrollable && component.getScrollable();\n                if (scrollable && !that.option(\"legacyRendering\")) {\n                  var rowElement = component.getRowElement(rowIndex),\n                    $rowElement = rowElement && rowElement[0] && (0, _renderer2.default)(rowElement[0]),\n                    top = $rowElement && $rowElement.position().top;\n                  if (top > 0) {\n                    top = Math.round(top + $rowElement.outerHeight() * (itemIndex % 1));\n                    scrollable.scrollTo({\n                      y: top\n                    });\n                  }\n                }\n              }\n            });\n          },\n          initVirtualRows: function initVirtualRows() {\n            var that = this,\n              virtualRowsRendering = isVirtualRowRendering(that);\n            if (\"virtual\" !== that.option(\"scrolling.mode\") && true !== virtualRowsRendering || false === virtualRowsRendering || that.option(\"legacyRendering\") || !that.option(\"scrolling.rowPageSize\")) {\n              that._visibleItems = null;\n              that._rowsScrollController = null;\n              return;\n            }\n            that._rowPageIndex = Math.ceil(that.pageIndex() * that.pageSize() / that.getRowPageSize());\n            that._visibleItems = [];\n            var isItemCountable = function isItemCountable(item) {\n              return \"data\" === item.rowType || \"group\" === item.rowType && that._dataSource.isGroupItemCountable(item.data);\n            };\n            that._rowsScrollController = new _uiGrid_core2.default.VirtualScrollController(that.component, {\n              pageSize: function pageSize() {\n                return that.getRowPageSize();\n              },\n              totalItemsCount: function totalItemsCount() {\n                return isVirtualMode(that) ? that.totalItemsCount() : that._items.filter(isItemCountable).length;\n              },\n              hasKnownLastPage: function hasKnownLastPage() {\n                return true;\n              },\n              pageIndex: function pageIndex(index) {\n                if (void 0 !== index) {\n                  that._rowPageIndex = index;\n                }\n                return that._rowPageIndex;\n              },\n              isLoading: function isLoading() {\n                return that.isLoading();\n              },\n              pageCount: function pageCount() {\n                var pageCount = Math.ceil(this.totalItemsCount() / this.pageSize());\n                return pageCount ? pageCount : 1;\n              },\n              load: function load() {\n                if (that._rowsScrollController.pageIndex() >= this.pageCount()) {\n                  that._rowPageIndex = this.pageCount() - 1;\n                  that._rowsScrollController.pageIndex(that._rowPageIndex);\n                }\n                if (!that._rowsScrollController._dataSource.items().length && this.totalItemsCount()) {\n                  return;\n                }\n                that._rowsScrollController.handleDataChanged(function (change) {\n                  change = change || {};\n                  change.changeType = change.changeType || \"refresh\";\n                  change.items = change.items || that._visibleItems;\n                  that._visibleItems.forEach(function (item, index) {\n                    item.rowIndex = index;\n                  });\n                  that._fireChanged(change);\n                });\n              },\n              updateLoading: function updateLoading() {},\n              itemsCount: function itemsCount() {\n                return that._rowsScrollController._dataSource.items().filter(isItemCountable).length;\n              },\n              correctCount: function correctCount(items, count, fromEnd) {\n                return _correctCount(items, count, fromEnd, isItemCountable);\n              },\n              items: function items(countableOnly) {\n                var dataSource = that.dataSource(),\n                  virtualItemsCount = dataSource && dataSource.virtualItemsCount(),\n                  begin = virtualItemsCount ? virtualItemsCount.begin : 0,\n                  rowPageSize = that.getRowPageSize();\n                var skip = that._rowPageIndex * rowPageSize - begin;\n                var take = rowPageSize;\n                var result = that._items;\n                if (skip < 0) {\n                  return [];\n                }\n                if (skip) {\n                  skip = this.correctCount(result, skip);\n                  result = result.slice(skip);\n                }\n                if (take) {\n                  take = this.correctCount(result, take);\n                  result = result.slice(0, take);\n                }\n                return countableOnly ? result.filter(isItemCountable) : result;\n              },\n              viewportItems: function viewportItems(items) {\n                if (items) {\n                  that._visibleItems = items;\n                }\n                return that._visibleItems;\n              },\n              onChanged: function onChanged() {},\n              changingDuration: function changingDuration(e) {\n                var dataSource = that.dataSource();\n                return dataSource && dataSource._renderTime || 0;\n              }\n            }, true);\n            if (that.isLoaded()) {\n              that._rowsScrollController.load();\n            }\n          },\n          _updateItemsCore: function _updateItemsCore(change) {\n            var _this = this;\n            var delta = this.getRowIndexDelta();\n            this.callBase.apply(this, arguments);\n            var rowsScrollController = this._rowsScrollController;\n            if (rowsScrollController) {\n              var visibleItems = this._visibleItems;\n              var isRefresh = \"refresh\" === change.changeType || change.isLiveUpdate;\n              if (\"append\" === change.changeType && change.items && !change.items.length) {\n                return;\n              }\n              if (isRefresh || \"append\" === change.changeType || \"prepend\" === change.changeType) {\n                change.cancel = true;\n                isRefresh && rowsScrollController.reset(true);\n                rowsScrollController.load();\n              } else {\n                if (\"update\" === change.changeType) {\n                  change.rowIndices.forEach(function (rowIndex, index) {\n                    var changeType = change.changeTypes[index];\n                    var newItem = change.items[index];\n                    if (\"update\" === changeType) {\n                      visibleItems[rowIndex] = newItem;\n                    } else {\n                      if (\"insert\" === changeType) {\n                        visibleItems.splice(rowIndex, 0, newItem);\n                      } else {\n                        if (\"remove\" === changeType) {\n                          visibleItems.splice(rowIndex, 1);\n                        }\n                      }\n                    }\n                  });\n                } else {\n                  visibleItems.forEach(function (item, index) {\n                    visibleItems[index] = _this._items[index + delta] || visibleItems[index];\n                  });\n                  change.items = visibleItems;\n                }\n                visibleItems.forEach(function (item, index) {\n                  item.rowIndex = index;\n                });\n              }\n            }\n          },\n          _applyChange: function _applyChange(change) {\n            var that = this,\n              items = change.items,\n              changeType = change.changeType,\n              removeCount = change.removeCount;\n            if (removeCount) {\n              var fromEnd = \"prepend\" === changeType;\n              removeCount = _correctCount(that._items, removeCount, fromEnd, function (item, isNextAfterLast) {\n                return \"data\" === item.rowType || \"group\" === item.rowType && (that._dataSource.isGroupItemCountable(item.data) || isNextAfterLast);\n              });\n              change.removeCount = removeCount;\n            }\n            switch (changeType) {\n              case \"prepend\":\n                that._items.unshift.apply(that._items, items);\n                if (removeCount) {\n                  that._items.splice(-removeCount);\n                }\n                break;\n              case \"append\":\n                that._items.push.apply(that._items, items);\n                if (removeCount) {\n                  that._items.splice(0, removeCount);\n                }\n                break;\n              default:\n                that.callBase(change);\n            }\n          },\n          items: function items(allItems) {\n            return allItems ? this._items : this._visibleItems || this._items;\n          },\n          getRowIndexDelta: function getRowIndexDelta() {\n            var visibleItems = this._visibleItems,\n              delta = 0;\n            if (visibleItems && visibleItems[0]) {\n              delta = this._items.indexOf(visibleItems[0]);\n            }\n            return delta < 0 ? 0 : delta;\n          },\n          getRowIndexOffset: function getRowIndexOffset() {\n            var offset = 0,\n              dataSource = this.dataSource(),\n              rowsScrollController = this._rowsScrollController;\n            if (rowsScrollController) {\n              offset = rowsScrollController.beginPageIndex() * rowsScrollController._dataSource.pageSize();\n            } else {\n              if (\"virtual\" === this.option(\"scrolling.mode\") && dataSource) {\n                offset = dataSource.beginPageIndex() * dataSource.pageSize();\n              }\n            }\n            return offset;\n          },\n          viewportSize: function viewportSize() {\n            var rowsScrollController = this._rowsScrollController;\n            rowsScrollController && rowsScrollController.viewportSize.apply(rowsScrollController, arguments);\n            var dataSource = this._dataSource;\n            return dataSource && dataSource.viewportSize.apply(dataSource, arguments);\n          },\n          viewportItemSize: function viewportItemSize() {\n            var rowsScrollController = this._rowsScrollController;\n            rowsScrollController && rowsScrollController.viewportItemSize.apply(rowsScrollController, arguments);\n            var dataSource = this._dataSource;\n            return dataSource && dataSource.viewportItemSize.apply(dataSource, arguments);\n          },\n          setViewportPosition: function setViewportPosition() {\n            var rowsScrollController = this._rowsScrollController,\n              dataSource = this._dataSource;\n            if (rowsScrollController) {\n              rowsScrollController.setViewportPosition.apply(rowsScrollController, arguments).done(function () {\n                dataSource && dataSource.setViewportItemIndex(rowsScrollController.getViewportItemIndex());\n              });\n            } else {\n              dataSource && dataSource.setViewportPosition.apply(dataSource, arguments);\n            }\n          },\n          setContentSize: function setContentSize(sizes) {\n            var rowsScrollController = this._rowsScrollController;\n            rowsScrollController && rowsScrollController.setContentSize(sizes);\n            var dataSource = this._dataSource;\n            return dataSource && dataSource.setContentSize(sizes);\n          },\n          loadIfNeed: function loadIfNeed() {\n            var rowsScrollController = this._rowsScrollController;\n            rowsScrollController && rowsScrollController.loadIfNeed();\n            var dataSource = this._dataSource;\n            return dataSource && dataSource.loadIfNeed();\n          },\n          getItemSize: function getItemSize() {\n            var rowsScrollController = this._rowsScrollController;\n            if (rowsScrollController) {\n              return rowsScrollController.getItemSize.apply(rowsScrollController, arguments);\n            }\n            var dataSource = this._dataSource;\n            return dataSource && dataSource.getItemSize.apply(dataSource, arguments);\n          },\n          getItemSizes: function getItemSizes() {\n            var rowsScrollController = this._rowsScrollController;\n            if (rowsScrollController) {\n              return rowsScrollController.getItemSizes.apply(rowsScrollController, arguments);\n            }\n            var dataSource = this._dataSource;\n            return dataSource && dataSource.getItemSizes.apply(dataSource, arguments);\n          },\n          getContentOffset: function getContentOffset() {\n            var rowsScrollController = this._rowsScrollController;\n            if (rowsScrollController) {\n              return rowsScrollController.getContentOffset.apply(rowsScrollController, arguments);\n            }\n            var dataSource = this._dataSource;\n            return dataSource && dataSource.getContentOffset.apply(dataSource, arguments);\n          },\n          dispose: function dispose() {\n            var rowsScrollController = this._rowsScrollController;\n            rowsScrollController && rowsScrollController.dispose();\n            this.callBase.apply(this, arguments);\n          }\n        };\n        _uiGrid_core4.default.proxyMethod(members, \"virtualItemsCount\");\n        _uiGrid_core4.default.proxyMethod(members, \"getVirtualContentSize\");\n        _uiGrid_core4.default.proxyMethod(members, \"setViewportItemIndex\");\n        return members;\n      }(),\n      resizing: {\n        resize: function resize() {\n          var result,\n            that = this,\n            callBase = that.callBase;\n          if (!that.option(\"legacyRendering\") && (isVirtualMode(that) || isVirtualRowRendering(that))) {\n            clearTimeout(that._resizeTimeout);\n            var diff = new Date() - that._lastTime;\n            var updateTimeout = that.option(\"scrolling.updateTimeout\");\n            if (that._lastTime && diff < updateTimeout) {\n              result = new _deferred.Deferred();\n              that._resizeTimeout = setTimeout(function () {\n                callBase.apply(that).done(result.resolve).fail(result.reject);\n                that._lastTime = new Date();\n              }, updateTimeout);\n              that._lastTime = new Date();\n            } else {\n              result = callBase.apply(that);\n              if (that._dataController.isLoaded()) {\n                that._lastTime = new Date();\n              }\n            }\n          } else {\n            result = callBase.apply(that);\n          }\n          return result;\n        },\n        dispose: function dispose() {\n          this.callBase.apply(this, arguments);\n          clearTimeout(this._resizeTimeout);\n        }\n      }\n    },\n    views: {\n      rowsView: VirtualScrollingRowsViewExtender\n    }\n  }\n};","map":null,"metadata":{},"sourceType":"script"}