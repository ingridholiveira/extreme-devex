{"ast":null,"code":"/**\r\n * DevExtreme (ui/grid_core/ui.grid_core.header_filter.js)\r\n * Version: 19.2.2\r\n * Build date: Tue Oct 01 2019\r\n *\r\n * Copyright (c) 2012 - 2019 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\n\"use strict\";\n\nvar _events_engine = require(\"../../events/core/events_engine\");\nvar _events_engine2 = _interopRequireDefault(_events_engine);\nvar _uiGrid_core = require(\"./ui.grid_core.modules\");\nvar _uiGrid_core2 = _interopRequireDefault(_uiGrid_core);\nvar _filtering = require(\"../shared/filtering\");\nvar _filtering2 = _interopRequireDefault(_filtering);\nvar _uiGrid_core3 = require(\"./ui.grid_core.utils\");\nvar _uiGrid_core4 = _interopRequireDefault(_uiGrid_core3);\nvar _uiGrid_core5 = require(\"./ui.grid_core.header_filter_core\");\nvar _message = require(\"../../localization/message\");\nvar _message2 = _interopRequireDefault(_message);\nvar _click = require(\"../../events/click\");\nvar _click2 = _interopRequireDefault(_click);\nvar _data = require(\"../../core/utils/data\");\nvar _iterator = require(\"../../core/utils/iterator\");\nvar _type = require(\"../../core/utils/type\");\nvar _position = require(\"../../core/utils/position\");\nvar _extend = require(\"../../core/utils/extend\");\nvar _data_source = require(\"../../data/data_source/data_source\");\nvar _date = require(\"../../localization/date\");\nvar _date2 = _interopRequireDefault(_date);\nvar _variable_wrapper = require(\"../../core/utils/variable_wrapper\");\nvar _deferred = require(\"../../core/utils/deferred\");\nvar _accessibility = require(\"../shared/accessibility\");\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    \"default\": obj\n  };\n}\nvar DATE_INTERVAL_FORMATS = {\n  month: function month(value) {\n    return _date2.default.getMonthNames()[value - 1];\n  },\n  quarter: function quarter(value) {\n    return _date2.default.format(new Date(2e3, 3 * value - 1), \"quarter\");\n  }\n};\nvar HeaderFilterController = _uiGrid_core2.default.ViewController.inherit(function () {\n  var getFormatOptions = function getFormatOptions(value, column, currentLevel) {\n    var groupInterval = _filtering2.default.getGroupInterval(column),\n      result = _uiGrid_core4.default.getFormatOptionsByColumn(column, \"headerFilter\");\n    if (groupInterval) {\n      result.groupInterval = groupInterval[currentLevel];\n      if (_uiGrid_core4.default.isDateType(column.dataType)) {\n        result.format = DATE_INTERVAL_FORMATS[groupInterval[currentLevel]];\n      } else {\n        if (\"number\" === column.dataType) {\n          result.getDisplayFormat = function () {\n            var formatOptions = {\n                format: column.format,\n                target: \"headerFilter\"\n              },\n              firstValueText = _uiGrid_core4.default.formatValue(value, formatOptions),\n              secondValue = value + groupInterval[currentLevel],\n              secondValueText = _uiGrid_core4.default.formatValue(secondValue, formatOptions);\n            return firstValueText && secondValueText ? firstValueText + \" - \" + secondValueText : \"\";\n          };\n        }\n      }\n    }\n    return result;\n  };\n  return {\n    init: function init() {\n      this._columnsController = this.getController(\"columns\");\n      this._dataController = this.getController(\"data\");\n      this._headerFilterView = this.getView(\"headerFilterView\");\n    },\n    _updateSelectedState: function _updateSelectedState(items, column) {\n      var i = items.length,\n        isExclude = \"exclude\" === column.filterType;\n      while (i--) {\n        var item = items[i];\n        if (\"items\" in items[i]) {\n          this._updateSelectedState(items[i].items, column);\n        }\n        (0, _uiGrid_core5.updateHeaderFilterItemSelectionState)(item, _uiGrid_core4.default.getIndexByKey(items[i].value, column.filterValues, null) > -1, isExclude);\n      }\n    },\n    _normalizeGroupItem: function _normalizeGroupItem(item, currentLevel, options) {\n      var value,\n        displayValue,\n        path = options.path,\n        valueSelector = options.valueSelector,\n        displaySelector = options.displaySelector,\n        column = options.column;\n      if (valueSelector && displaySelector) {\n        value = valueSelector(item);\n        displayValue = displaySelector(item);\n      } else {\n        value = item.key;\n        displayValue = value;\n      }\n      if (!(0, _type.isObject)(item)) {\n        item = {};\n      } else {\n        item = (0, _extend.extend)({}, item);\n      }\n      path.push(value);\n      if (1 === path.length) {\n        item.value = path[0];\n      } else {\n        item.value = path.join(\"/\");\n      }\n      item.text = this.getHeaderItemText(displayValue, column, currentLevel, options.headerFilterOptions);\n      return item;\n    },\n    getHeaderItemText: function getHeaderItemText(displayValue, column, currentLevel, headerFilterOptions) {\n      var text = _uiGrid_core4.default.formatValue(displayValue, getFormatOptions(displayValue, column, currentLevel));\n      if (!text) {\n        text = headerFilterOptions.texts.emptyValue;\n      }\n      return text;\n    },\n    _processGroupItems: function _processGroupItems(groupItems, currentLevel, path, options) {\n      var displaySelector,\n        valueSelector,\n        that = this,\n        column = options.column,\n        lookup = column.lookup,\n        level = options.level;\n      path = path || [];\n      currentLevel = currentLevel || 0;\n      if (lookup) {\n        displaySelector = (0, _data.compileGetter)(lookup.displayExpr);\n        valueSelector = (0, _data.compileGetter)(lookup.valueExpr);\n      }\n      for (var i = 0; i < groupItems.length; i++) {\n        groupItems[i] = that._normalizeGroupItem(groupItems[i], currentLevel, {\n          column: options.column,\n          headerFilterOptions: options.headerFilterOptions,\n          displaySelector: displaySelector,\n          valueSelector: valueSelector,\n          path: path\n        });\n        if (\"items\" in groupItems[i]) {\n          if (currentLevel === level || !(0, _type.isDefined)(groupItems[i].value)) {\n            delete groupItems[i].items;\n          } else {\n            that._processGroupItems(groupItems[i].items, currentLevel + 1, path, options);\n          }\n        }\n        path.pop();\n      }\n    },\n    getDataSource: function getDataSource(column) {\n      var filter,\n        cutoffLevel,\n        origPostProcess,\n        that = this,\n        dataSource = that._dataController.dataSource(),\n        group = _uiGrid_core4.default.getHeaderFilterGroupParameters(column, dataSource && dataSource.remoteOperations().grouping),\n        headerFilterDataSource = column.headerFilter && column.headerFilter.dataSource,\n        headerFilterOptions = that.option(\"headerFilter\"),\n        isLookup = false,\n        options = {\n          component: that.component\n        };\n      if (!dataSource) {\n        return;\n      }\n      if ((0, _type.isDefined)(headerFilterDataSource) && !(0, _type.isFunction)(headerFilterDataSource)) {\n        options.dataSource = (0, _data_source.normalizeDataSourceOptions)(headerFilterDataSource);\n      } else {\n        if (column.lookup) {\n          isLookup = true;\n          dataSource = column.lookup.dataSource;\n          if ((0, _type.isFunction)(dataSource) && !(0, _variable_wrapper.isWrapped)(dataSource)) {\n            dataSource = dataSource({});\n          }\n          dataSource = (0, _data_source.normalizeDataSourceOptions)(dataSource);\n          options.dataSource = dataSource;\n        } else {\n          cutoffLevel = Array.isArray(group) ? group.length - 1 : 0;\n          that._currentColumn = column;\n          filter = that._dataController.getCombinedFilter();\n          that._currentColumn = null;\n          options.dataSource = {\n            filter: filter,\n            group: group,\n            useDefaultSearch: true,\n            load: function load(options) {\n              var d = new _deferred.Deferred();\n              options.dataField = column.dataField || column.name;\n              dataSource.load(options).done(function (data) {\n                that._processGroupItems(data, null, null, {\n                  level: cutoffLevel,\n                  column: column,\n                  headerFilterOptions: headerFilterOptions\n                });\n                d.resolve(data);\n              }).fail(d.reject);\n              return d;\n            }\n          };\n        }\n      }\n      if ((0, _type.isFunction)(headerFilterDataSource)) {\n        headerFilterDataSource.call(column, options);\n      }\n      origPostProcess = options.dataSource.postProcess;\n      options.dataSource.postProcess = function (data) {\n        var items = data;\n        if (isLookup) {\n          if (0 === this.pageIndex() && !this.searchValue()) {\n            items = items.slice(0);\n            items.unshift(null);\n          }\n          that._processGroupItems(items, null, null, {\n            level: 0,\n            column: column,\n            headerFilterOptions: headerFilterOptions\n          });\n        }\n        items = origPostProcess && origPostProcess.call(this, items) || items;\n        that._updateSelectedState(items, column);\n        return items;\n      };\n      return options.dataSource;\n    },\n    getCurrentColumn: function getCurrentColumn() {\n      return this._currentColumn;\n    },\n    showHeaderFilterMenu: function showHeaderFilterMenu(columnIndex, isGroupPanel) {\n      var columnsController = this._columnsController,\n        column = (0, _extend.extend)(true, {}, this._columnsController.getColumns()[columnIndex]);\n      if (column) {\n        var visibleIndex = columnsController.getVisibleIndex(columnIndex),\n          view = isGroupPanel ? this.getView(\"headerPanel\") : this.getView(\"columnHeadersView\"),\n          $columnElement = $columnElement || view.getColumnElements().eq(isGroupPanel ? column.groupIndex : visibleIndex);\n        this.showHeaderFilterMenuBase({\n          columnElement: $columnElement,\n          column: column,\n          applyFilter: true,\n          apply: function apply() {\n            columnsController.columnOption(columnIndex, {\n              filterValues: this.filterValues,\n              filterType: this.filterType\n            });\n          }\n        });\n      }\n    },\n    showHeaderFilterMenuBase: function showHeaderFilterMenuBase(options) {\n      var _this = this;\n      var that = this,\n        column = options.column;\n      if (column) {\n        var groupInterval = _filtering2.default.getGroupInterval(column),\n          dataSource = that._dataController.dataSource(),\n          remoteFiltering = dataSource && dataSource.remoteOperations().filtering;\n        (0, _extend.extend)(options, column, {\n          type: groupInterval && groupInterval.length > 1 ? \"tree\" : \"list\",\n          remoteFiltering: remoteFiltering,\n          onShowing: function onShowing(e) {\n            var dxResizableInstance = e.component.overlayContent().dxResizable(\"instance\");\n            dxResizableInstance && dxResizableInstance.option(\"onResizeEnd\", function (e) {\n              var columnsController = that.getController(\"columns\"),\n                headerFilterByColumn = columnsController.columnOption(options.dataField, \"headerFilter\");\n              headerFilterByColumn = headerFilterByColumn || {};\n              headerFilterByColumn.width = e.width;\n              headerFilterByColumn.height = e.height;\n              columnsController.columnOption(options.dataField, \"headerFilter\", headerFilterByColumn, true);\n            });\n          },\n          onHidden: function onHidden() {\n            return (0, _accessibility.restoreFocus)(_this);\n          }\n        });\n        options.dataSource = that.getDataSource(options);\n        if (options.isFilterBuilder) {\n          options.dataSource.filter = null;\n          options.alignment = \"right\";\n        }\n        that._headerFilterView.showHeaderFilterMenu(options.columnElement, options);\n      }\n    },\n    hideHeaderFilterMenu: function hideHeaderFilterMenu() {\n      this._headerFilterView.hideHeaderFilterMenu();\n    }\n  };\n}());\nvar ColumnHeadersViewHeaderFilterExtender = (0, _extend.extend)({}, _uiGrid_core5.headerFilterMixin, {\n  _renderCellContent: function _renderCellContent($cell, options) {\n    var $headerFilterIndicator,\n      that = this,\n      column = options.column;\n    if (!column.command && (0, _uiGrid_core5.allowHeaderFiltering)(column) && that.option(\"headerFilter.visible\") && \"header\" === options.rowType) {\n      $headerFilterIndicator = that._applyColumnState({\n        name: \"headerFilter\",\n        rootElement: $cell,\n        column: column,\n        showColumnLines: that.option(\"showColumnLines\")\n      });\n      $headerFilterIndicator && that._subscribeToIndicatorEvent($headerFilterIndicator, column, \"headerFilter\");\n    }\n    that.callBase($cell, options);\n  },\n  _subscribeToIndicatorEvent: function _subscribeToIndicatorEvent($indicator, column, indicatorName) {\n    var that = this;\n    if (\"headerFilter\" === indicatorName) {\n      _events_engine2.default.on($indicator, _click2.default.name, that.createAction(function (e) {\n        e.event.stopPropagation();\n        that.getController(\"headerFilter\").showHeaderFilterMenu(column.index, false);\n      }));\n    }\n  },\n  _updateIndicator: function _updateIndicator($cell, column, indicatorName) {\n    var $indicator = this.callBase($cell, column, indicatorName);\n    $indicator && this._subscribeToIndicatorEvent($indicator, column, indicatorName);\n  },\n  _updateHeaderFilterIndicators: function _updateHeaderFilterIndicators() {\n    if (this.option(\"headerFilter.visible\")) {\n      this._updateIndicators(\"headerFilter\");\n    }\n  },\n  _needUpdateFilterIndicators: function _needUpdateFilterIndicators() {\n    return true;\n  },\n  _columnOptionChanged: function _columnOptionChanged(e) {\n    var optionNames = e.optionNames;\n    if (_uiGrid_core4.default.checkChanges(optionNames, [\"filterValues\", \"filterType\"])) {\n      if (this._needUpdateFilterIndicators()) {\n        this._updateHeaderFilterIndicators();\n      }\n      return;\n    }\n    this.callBase(e);\n  }\n});\nvar HeaderPanelHeaderFilterExtender = (0, _extend.extend)({}, _uiGrid_core5.headerFilterMixin, {\n  _createGroupPanelItem: function _createGroupPanelItem($rootElement, groupColumn) {\n    var $headerFilterIndicator,\n      that = this,\n      $item = that.callBase.apply(that, arguments);\n    if (!groupColumn.command && (0, _uiGrid_core5.allowHeaderFiltering)(groupColumn) && that.option(\"headerFilter.visible\")) {\n      $headerFilterIndicator = that._applyColumnState({\n        name: \"headerFilter\",\n        rootElement: $item,\n        column: {\n          alignment: (0, _position.getDefaultAlignment)(that.option(\"rtlEnabled\")),\n          filterValues: groupColumn.filterValues,\n          allowHeaderFiltering: true\n        },\n        showColumnLines: true\n      });\n      $headerFilterIndicator && _events_engine2.default.on($headerFilterIndicator, _click2.default.name, that.createAction(function (e) {\n        var event = e.event;\n        event.stopPropagation();\n        that.getController(\"headerFilter\").showHeaderFilterMenu(groupColumn.index, true);\n      }));\n    }\n    return $item;\n  }\n});\nfunction invertFilterExpression(filter) {\n  return [\"!\", filter];\n}\nvar DataControllerFilterRowExtender = {\n  skipCalculateColumnFilters: function skipCalculateColumnFilters() {\n    return false;\n  },\n  _calculateAdditionalFilter: function _calculateAdditionalFilter() {\n    if (this.skipCalculateColumnFilters()) {\n      return this.callBase();\n    }\n    var that = this,\n      filters = [that.callBase()],\n      columns = that._columnsController.getVisibleColumns(),\n      headerFilterController = that.getController(\"headerFilter\"),\n      currentColumn = headerFilterController.getCurrentColumn();\n    (0, _iterator.each)(columns, function (_, column) {\n      var filter;\n      if (currentColumn && currentColumn.index === column.index) {\n        return;\n      }\n      if ((0, _uiGrid_core5.allowHeaderFiltering)(column) && column.calculateFilterExpression && Array.isArray(column.filterValues) && column.filterValues.length) {\n        var filterValues = [];\n        (0, _iterator.each)(column.filterValues, function (_, filterValue) {\n          if (Array.isArray(filterValue)) {\n            filter = filterValue;\n          } else {\n            if (column.deserializeValue && !_uiGrid_core4.default.isDateType(column.dataType) && \"number\" !== column.dataType) {\n              filterValue = column.deserializeValue(filterValue);\n            }\n            filter = column.createFilterExpression(filterValue, \"=\", \"headerFilter\");\n          }\n          if (filter) {\n            filter.columnIndex = column.index;\n          }\n          filterValues.push(filter);\n        });\n        filterValues = _uiGrid_core4.default.combineFilters(filterValues, \"or\");\n        filters.push(\"exclude\" === column.filterType ? [\"!\", filterValues] : filterValues);\n      }\n    });\n    return _uiGrid_core4.default.combineFilters(filters);\n  }\n};\nmodule.exports = {\n  invertFilterExpression: invertFilterExpression,\n  defaultOptions: function defaultOptions() {\n    return {\n      headerFilter: {\n        visible: false,\n        width: 252,\n        height: 325,\n        allowSearch: false,\n        searchTimeout: 500,\n        texts: {\n          emptyValue: _message2.default.format(\"dxDataGrid-headerFilterEmptyValue\"),\n          ok: _message2.default.format(\"dxDataGrid-headerFilterOK\"),\n          cancel: _message2.default.format(\"dxDataGrid-headerFilterCancel\")\n        }\n      }\n    };\n  },\n  controllers: {\n    headerFilter: HeaderFilterController\n  },\n  views: {\n    headerFilterView: _uiGrid_core5.HeaderFilterView\n  },\n  extenders: {\n    controllers: {\n      data: DataControllerFilterRowExtender\n    },\n    views: {\n      columnHeadersView: ColumnHeadersViewHeaderFilterExtender,\n      headerPanel: HeaderPanelHeaderFilterExtender\n    }\n  }\n};","map":null,"metadata":{},"sourceType":"script"}