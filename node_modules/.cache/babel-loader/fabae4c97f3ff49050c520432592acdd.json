{"ast":null,"code":"/**\r\n * DevExtreme (ui/collection/ui.collection_widget.live_update.js)\r\n * Version: 19.2.2\r\n * Build date: Tue Oct 01 2019\r\n *\r\n * Copyright (c) 2012 - 2019 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\n\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nvar _renderer = require(\"../../core/renderer\");\nvar _renderer2 = _interopRequireDefault(_renderer);\nvar _uiCollection_widget = require(\"./ui.collection_widget.edit\");\nvar _uiCollection_widget2 = _interopRequireDefault(_uiCollection_widget);\nvar _extend = require(\"../../core/utils/extend\");\nvar _type = require(\"../../core/utils/type\");\nvar _array_utils = require(\"../../data/array_utils\");\nvar _array_utils2 = _interopRequireDefault(_array_utils);\nvar _utils = require(\"../../data/utils\");\nvar _deferred = require(\"../../core/utils/deferred\");\nvar _array_compare = require(\"../../core/utils/array_compare\");\nvar _dom_adapter = require(\"../../core/dom_adapter\");\nvar _common = require(\"../../core/utils/common\");\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    \"default\": obj\n  };\n}\nexports.default = _uiCollection_widget2.default.inherit({\n  _getDefaultOptions: function _getDefaultOptions() {\n    return (0, _extend.extend)(this.callBase(), {\n      repaintChangesOnly: false\n    });\n  },\n  ctor: function ctor() {\n    var _this = this;\n    this.callBase.apply(this, arguments);\n    this._customizeStoreLoadOptions = function (e) {\n      var dataSource = _this._dataSource;\n      if (dataSource && !dataSource.isLoaded()) {\n        _this._correctionIndex = 0;\n      }\n      if (_this._correctionIndex && e.storeLoadOptions) {\n        e.storeLoadOptions.skip += _this._correctionIndex;\n      }\n    }, this._dataSource && this._dataSource.on(\"customizeStoreLoadOptions\", this._customizeStoreLoadOptions);\n  },\n  reload: function reload() {\n    this._correctionIndex = 0;\n  },\n  _init: function _init() {\n    this.callBase();\n    this._refreshItemsCache();\n    this._correctionIndex = 0;\n  },\n  _findItemElementByKey: function _findItemElementByKey(key) {\n    var _this2 = this;\n    var result = (0, _renderer2.default)();\n    var keyExpr = this.key();\n    this.itemElements().each(function (_, item) {\n      var $item = (0, _renderer2.default)(item),\n        itemData = _this2._getItemData($item);\n      if (keyExpr ? (0, _utils.keysEqual)(keyExpr, _this2.keyOf(itemData), key) : _this2._isItemEquals(itemData, key)) {\n        result = $item;\n        return false;\n      }\n    });\n    return result;\n  },\n  _dataSourceChangedHandler: function _dataSourceChangedHandler(newItems, e) {\n    e && e.changes ? this._modifyByChanges(e.changes) : this.callBase(newItems, e);\n  },\n  _isItemEquals: function _isItemEquals(item1, item2) {\n    try {\n      return JSON.stringify(item1) === JSON.stringify(item2);\n    } catch (e) {\n      return item1 === item2;\n    }\n  },\n  _partialRefresh: function _partialRefresh() {\n    if (this.option(\"repaintChangesOnly\")) {\n      var result = (0, _array_compare.findChanges)(this._itemsCache, this._editStrategy.itemsGetter(), this.keyOf.bind(this), this._isItemEquals);\n      if (result && this._itemsCache.length) {\n        this._modifyByChanges(result, true);\n        this._renderEmptyMessage();\n        return true;\n      } else {\n        this._refreshItemsCache();\n      }\n    }\n    return false;\n  },\n  _refreshItemsCache: function _refreshItemsCache() {\n    if (this.option(\"repaintChangesOnly\")) {\n      try {\n        this._itemsCache = (0, _extend.extend)(true, [], this._editStrategy.itemsGetter());\n      } catch (e) {\n        this._itemsCache = (0, _extend.extend)([], this._editStrategy.itemsGetter());\n      }\n    }\n  },\n  _dispose: function _dispose() {\n    this._dataSource && this._dataSource.off(\"customizeStoreLoadOptions\", this._customizeStoreLoadOptions);\n    this.callBase();\n  },\n  _updateByChange: function _updateByChange(keyInfo, items, change, isPartialRefresh) {\n    var _this3 = this;\n    if (isPartialRefresh) {\n      this._renderItem(change.index, change.data, null, this._findItemElementByKey(change.key));\n    } else {\n      var changedItem = items[_array_utils2.default.indexByKey(keyInfo, items, change.key)];\n      if (changedItem) {\n        _array_utils2.default.update(keyInfo, items, change.key, change.data).done(function () {\n          _this3._renderItem(items.indexOf(changedItem), changedItem, null, _this3._findItemElementByKey(change.key));\n        });\n      }\n    }\n  },\n  _insertByChange: function _insertByChange(keyInfo, items, change, isPartialRefresh) {\n    var _this4 = this;\n    (0, _deferred.when)(isPartialRefresh || _array_utils2.default.insert(keyInfo, items, change.data, change.index)).done(function () {\n      _this4._beforeItemElementInserted(change);\n      _this4._renderItem((0, _type.isDefined)(change.index) ? change.index : items.length, change.data);\n      _this4._afterItemElementInserted();\n      _this4._correctionIndex++;\n    });\n  },\n  _updateSelectionAfterRemoveByChange: function _updateSelectionAfterRemoveByChange(removeIndex) {\n    var selectedIndex = this.option(\"selectedIndex\");\n    if (selectedIndex > removeIndex) {\n      this.option(\"selectedIndex\", selectedIndex - 1);\n    } else {\n      if (selectedIndex === removeIndex && 1 === this.option(\"selectedItems\").length) {\n        this.option(\"selectedItems\", []);\n      } else {\n        this._normalizeSelectedItems();\n      }\n    }\n  },\n  _beforeItemElementInserted: function _beforeItemElementInserted(change) {\n    var selectedIndex = this.option(\"selectedIndex\");\n    if (change.index <= selectedIndex) {\n      this.option(\"selectedIndex\", selectedIndex + 1);\n    }\n  },\n  _afterItemElementInserted: _common.noop,\n  _removeByChange: function _removeByChange(keyInfo, items, change, isPartialRefresh) {\n    var _this5 = this;\n    var index = isPartialRefresh ? change.index : _array_utils2.default.indexByKey(keyInfo, items, change.key),\n      removedItem = isPartialRefresh ? change.oldItem : items[index];\n    if (removedItem) {\n      var $removedItemElement = this._findItemElementByKey(change.key),\n        deletedActionArgs = this._extendActionArgs($removedItemElement);\n      this._waitDeletingPrepare($removedItemElement).done(function () {\n        if (isPartialRefresh) {\n          _this5._updateIndicesAfterIndex(index - 1);\n          _this5._afterItemElementDeleted($removedItemElement, deletedActionArgs);\n          _this5._updateSelectionAfterRemoveByChange(index);\n        } else {\n          _this5._deleteItemElementByIndex(index);\n          _this5._afterItemElementDeleted($removedItemElement, deletedActionArgs);\n        }\n      });\n      this._correctionIndex--;\n    }\n  },\n  _modifyByChanges: function _modifyByChanges(changes, isPartialRefresh) {\n    var _this6 = this;\n    var items = this._editStrategy.itemsGetter(),\n      keyInfo = {\n        key: this.key.bind(this),\n        keyOf: this.keyOf.bind(this)\n      },\n      dataSource = this._dataSource,\n      paginate = dataSource && dataSource.paginate(),\n      group = dataSource && dataSource.group();\n    if (paginate || group) {\n      changes = changes.filter(function (item) {\n        return \"insert\" !== item.type || void 0 !== item.index;\n      });\n    }\n    changes.forEach(function (change) {\n      return _this6[\"_\" + change.type + \"ByChange\"](keyInfo, items, change, isPartialRefresh);\n    });\n    this._renderedItemsCount = items.length;\n    this._refreshItemsCache();\n    this._fireContentReadyAction();\n  },\n  _appendItemToContainer: function _appendItemToContainer($container, $itemFrame, index) {\n    var nextSiblingElement = $container.children(this._itemSelector()).get(index);\n    (0, _dom_adapter.insertElement)($container.get(0), $itemFrame.get(0), nextSiblingElement);\n  },\n  _optionChanged: function _optionChanged(args) {\n    switch (args.name) {\n      case \"items\":\n        var isItemsUpdated = this._partialRefresh(args.value);\n        if (!isItemsUpdated) {\n          this.callBase(args);\n        }\n        break;\n      case \"dataSource\":\n        if (!this.option(\"repaintChangesOnly\") || !args.value) {\n          this.option(\"items\", []);\n        }\n        this.callBase(args);\n        break;\n      case \"repaintChangesOnly\":\n        break;\n      default:\n        this.callBase(args);\n    }\n  }\n});","map":null,"metadata":{},"sourceType":"script"}